

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>EVM Execution &mdash; The EVM Jello Paper 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex/"/>
        <link rel="search" title="Search" href="../search/"/>
    <link rel="top" title="The EVM Jello Paper 0.1 documentation" href="../"/>
        <link rel="next" title="Ethereum Simulations" href="../ethereum/"/>
        <link rel="prev" title="The EVM Jello Paper" href="../"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../" class="icon icon-home"> The EVM Jello Paper
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">EVM Execution</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#modal-semantics">Modal Semantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hardware">Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="#opcode-execution-cycle">OpCode Execution Cycle</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#evm-programs">EVM Programs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#evm-opcodes">EVM OpCodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ethereum-network-opcodes">Ethereum Network OpCodes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#precompiled-contracts">Precompiled Contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="#ethereum-gas-calculation">Ethereum Gas Calculation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#memory-consumption">Memory Consumption</a></li>
<li class="toctree-l2"><a class="reference internal" href="#execution-gas">Execution Gas</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fee-schedule-from-c-implementation">Fee Schedule from C++ Implementation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id605">};</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#evm-program-representations">EVM Program Representations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#disassembler">Disassembler</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ethereum/">Ethereum Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../verification/">KEVM Verification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/">EVM Words</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/#data-structures">Data Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/#parsing-unparsing">Parsing/Unparsing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/#recursive-length-prefix-rlp">Recursive Length Prefix (RLP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analysis/">Analysis Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../krypto/">Cryptographic Primitives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../issues/">EVM Design Issues</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">The EVM Jello Paper</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../">Docs</a> &raquo;</li>
        
      <li>EVM Execution</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/evm.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="evm-execution">
<h1>EVM Execution<a class="headerlink" href="#evm-execution" title="Permalink to this headline">¶</a></h1>
<p>The EVM is a stack machine over some simple opcodes.
Most of the opcodes are “local” to the execution state of the machine, but some of them must interact with the world state.
This file only defines the local execution operations, the file <cite>ethereum.md</cite> will define the interactions with the world state.</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>{.k .uiuck .rvk}
requires “data.k”</p>
<dl class="docutils">
<dt>module EVM</dt>
<dd>imports STRING
imports EVM-DATA</dd>
</dl>
<p><a href="#id5"><span class="problematic" id="id6">``</span></a><a href="#id7"><span class="problematic" id="id8">`</span></a></p>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>The configuration has cells for the current account id, the current opcode, the program counter, the current gas, the gas price, the current program, the word stack, and the local memory.
In addition, there are cells for the callstack and execution substate.</p>
<p>We’ve broken up the configuration into two components; those parts of the state that mutate during execution of a single transaction and those that are static throughout.
In the comments next to each cell, we’ve marked which component of the yellowpaper state corresponds to each cell.</p>
<dl class="docutils">
<dt><a href="#id9"><span class="problematic" id="id10">``</span></a><a href="#id11"><span class="problematic" id="id12">`</span></a>{.k .uiuck .rvk}</dt>
<dd><dl class="first last docutils">
<dt>configuration &lt;k&gt; $PGM:EthereumSimulation &lt;/k&gt;</dt>
<dd><p class="first">&lt;exit-code exit=”“&gt; 1 &lt;/exit-code&gt;
&lt;mode&gt; $MODE:Mode &lt;/mode&gt;
&lt;schedule&gt; $SCHEDULE:Schedule &lt;/schedule&gt;
&lt;analysis&gt; .Map &lt;/analysis&gt;</p>
<p>&lt;ethereum&gt;</p>
<blockquote class="last">
<div><p>// EVM Specific
// ============</p>
<p>&lt;evm&gt;</p>
<blockquote>
<div><p>// Mutable during a single transaction
// ———————————–</p>
<p>&lt;output&gt;        .WordStack &lt;/output&gt;              // H_RETURN
&lt;memoryUsed&gt;    0          &lt;/memoryUsed&gt;          // mu_i
&lt;callDepth&gt;     0          &lt;/callDepth&gt;
&lt;callStack&gt;     .List      &lt;/callStack&gt;
&lt;interimStates&gt; .List      &lt;/interimStates&gt;
&lt;substateStack&gt; .List      &lt;/substateStack&gt;
&lt;callLog&gt;       .Set       &lt;/callLog&gt;</p>
<dl class="docutils">
<dt>&lt;txExecState&gt;</dt>
<dd><p class="first">&lt;program&gt;      .Map       &lt;/program&gt;            // I_b
&lt;programBytes&gt; .WordStack &lt;/programBytes&gt;</p>
<p>// I_*
&lt;id&gt;        0          &lt;/id&gt;                    // I_a
&lt;caller&gt;    0          &lt;/caller&gt;                // I_s
&lt;callData&gt;  .WordStack &lt;/callData&gt;              // I_d
&lt;callValue&gt; 0          &lt;/callValue&gt;             // I_v</p>
<p class="last">// mu_*
&lt;wordStack&gt;   .WordStack &lt;/wordStack&gt;           // mu_s
&lt;localMem&gt;    .Map       &lt;/localMem&gt;            // mu_m
&lt;pc&gt;          0          &lt;/pc&gt;                  // mu_pc
&lt;gas&gt;         0          &lt;/gas&gt;                 // mu_g
&lt;previousGas&gt; 0          &lt;/previousGas&gt;</p>
</dd>
</dl>
<p>&lt;/txExecState&gt;</p>
<p>// A_* (execution substate)
&lt;substate&gt;</p>
<blockquote>
<div>&lt;selfDestruct&gt; .Set  &lt;/selfDestruct&gt;            // A_s
&lt;log&gt;          .List &lt;/log&gt;                     // A_l
&lt;refund&gt;       0     &lt;/refund&gt;                  // A_r</div></blockquote>
<p>&lt;/substate&gt;</p>
<p>// Immutable during a single transaction
// ————————————-</p>
<p>&lt;gasPrice&gt; 0 &lt;/gasPrice&gt;                          // I_p
&lt;origin&gt;   0 &lt;/origin&gt;                            // I_o</p>
<p>// I_H* (block information)
&lt;previousHash&gt;     0          &lt;/previousHash&gt;     // I_Hp
&lt;ommersHash&gt;       0          &lt;/ommersHash&gt;       // I_Ho
&lt;coinbase&gt;         0          &lt;/coinbase&gt;         // I_Hc
&lt;stateRoot&gt;        0          &lt;/stateRoot&gt;        // I_Hr
&lt;transactionsRoot&gt; 0          &lt;/transactionsRoot&gt; // I_Ht
&lt;receiptsRoot&gt;     0          &lt;/receiptsRoot&gt;     // I_He
&lt;logsBloom&gt;        .WordStack &lt;/logsBloom&gt;        // I_Hb
&lt;difficulty&gt;       0          &lt;/difficulty&gt;       // I_Hd
&lt;number&gt;           0          &lt;/number&gt;           // I_Hi
&lt;gasLimit&gt;         0          &lt;/gasLimit&gt;         // I_Hl
&lt;gasUsed&gt;          0          &lt;/gasUsed&gt;          // I_Hg
&lt;timestamp&gt;        0          &lt;/timestamp&gt;        // I_Hs
&lt;extraData&gt;        .WordStack &lt;/extraData&gt;        // I_Hx
&lt;mixHash&gt;          0          &lt;/mixHash&gt;          // I_Hm
&lt;blockNonce&gt;       0          &lt;/blockNonce&gt;       // I_Hn</p>
<p>&lt;ommerBlockHeaders&gt; [ .JSONList ] &lt;/ommerBlockHeaders&gt;
&lt;blockhash&gt;         .List         &lt;/blockhash&gt;</p>
</div></blockquote>
<p>&lt;/evm&gt;</p>
<p>// Ethereum Network
// ================</p>
<p>&lt;network&gt;</p>
<blockquote>
<div><p>// Accounts Record
// —————</p>
<p>&lt;activeAccounts&gt; .Map &lt;/activeAccounts&gt;
&lt;accounts&gt;</p>
</div></blockquote>
</div></blockquote>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id13"><span class="problematic" id="id14">``</span></a><a href="#id15"><span class="problematic" id="id16">`</span></a></p>
<ul class="simple">
<li>UIUC-K and RV-K have slight differences of opinion here.</li>
</ul>
<dl class="docutils">
<dt><a href="#id17"><span class="problematic" id="id18">``</span></a><a href="#id19"><span class="problematic" id="id20">`</span></a>{.k .uiuck}</dt>
<dd>&lt;account multiplicity=”*” type=”Bag”&gt;</dd>
</dl>
<p><a href="#id21"><span class="problematic" id="id22">``</span></a><a href="#id23"><span class="problematic" id="id24">`</span></a></p>
<dl class="docutils">
<dt><a href="#id25"><span class="problematic" id="id26">``</span></a><a href="#id27"><span class="problematic" id="id28">`</span></a>{.k .rvk}</dt>
<dd>&lt;account multiplicity=”*” type=”Map”&gt;</dd>
</dl>
<p><a href="#id29"><span class="problematic" id="id30">``</span></a><a href="#id31"><span class="problematic" id="id32">`</span></a></p>
<dl class="docutils">
<dt><a href="#id33"><span class="problematic" id="id34">``</span></a><a href="#id35"><span class="problematic" id="id36">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div><blockquote>
<div>&lt;acctID&gt;  0          &lt;/acctID&gt;
&lt;balance&gt; 0          &lt;/balance&gt;
&lt;code&gt;    .WordStack &lt;/code&gt;
&lt;storage&gt; .Map       &lt;/storage&gt;
&lt;nonce&gt;   0          &lt;/nonce&gt;</div></blockquote>
<p>&lt;/account&gt;</p>
</div></blockquote>
<p>&lt;/accounts&gt;</p>
<p>// Transactions Record
// ——————-</p>
<p>&lt;txOrder&gt;   .List &lt;/txOrder&gt;
&lt;txPending&gt; .List &lt;/txPending&gt;</p>
<p class="last">&lt;messages&gt;</p>
</dd>
</dl>
<p><a href="#id37"><span class="problematic" id="id38">``</span></a><a href="#id39"><span class="problematic" id="id40">`</span></a></p>
<ul class="simple">
<li>UIUC-K and RV-K have slight differences of opinion here.</li>
</ul>
<dl class="docutils">
<dt><a href="#id41"><span class="problematic" id="id42">``</span></a><a href="#id43"><span class="problematic" id="id44">`</span></a>{.k .uiuck}</dt>
<dd>&lt;message multiplicity=”*” type=”Bag”&gt;</dd>
</dl>
<p><a href="#id45"><span class="problematic" id="id46">``</span></a><a href="#id47"><span class="problematic" id="id48">`</span></a></p>
<dl class="docutils">
<dt><a href="#id49"><span class="problematic" id="id50">``</span></a><a href="#id51"><span class="problematic" id="id52">`</span></a>{.k .rvk}</dt>
<dd>&lt;message multiplicity=”*” type=”Map”&gt;</dd>
</dl>
<p><a href="#id53"><span class="problematic" id="id54">``</span></a><a href="#id55"><span class="problematic" id="id56">`</span></a></p>
<dl class="docutils">
<dt><a href="#id57"><span class="problematic" id="id58">``</span></a><a href="#id59"><span class="problematic" id="id60">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>&lt;msgID&gt;      0          &lt;/msgID&gt;
&lt;txNonce&gt;    0          &lt;/txNonce&gt;            // T_n
&lt;txGasPrice&gt; 0          &lt;/txGasPrice&gt;         // T_p
&lt;txGasLimit&gt; 0          &lt;/txGasLimit&gt;         // T_g
&lt;to&gt;         .Account   &lt;/to&gt;                 // T_t
&lt;value&gt;      0          &lt;/value&gt;              // T_v
&lt;v&gt;          0          &lt;/v&gt;                  // T_w
&lt;r&gt;          .WordStack &lt;/r&gt;                  // T_r
&lt;s&gt;          .WordStack &lt;/s&gt;                  // T_s
&lt;data&gt;       .WordStack &lt;/data&gt;               // T_i/T_e</div></blockquote>
<p>&lt;/message&gt;</p>
</div></blockquote>
<p>&lt;/messages&gt;</p>
</div></blockquote>
<p>&lt;/network&gt;</p>
</div></blockquote>
<p>&lt;/ethereum&gt;</p>
</div></blockquote>
<p>syntax EthereumSimulation</p>
</div></blockquote>
<p class="last">// ————————-</p>
</dd>
</dl>
<p><a href="#id61"><span class="problematic" id="id62">``</span></a><a href="#id63"><span class="problematic" id="id64">`</span></a></p>
</div>
<div class="section" id="modal-semantics">
<h2>Modal Semantics<a class="headerlink" href="#modal-semantics" title="Permalink to this headline">¶</a></h2>
<p>Our semantics is modal, with the initial mode being set on the command line via <cite>-cMODE=EXECMODE</cite>.</p>
<ul class="simple">
<li><cite>NORMAL</cite> executes as a client on the network would.</li>
<li><cite>VMTESTS</cite> skips <cite>CALL*</cite> and <cite>CREATE</cite> operations.</li>
</ul>
<dl class="docutils">
<dt><a href="#id65"><span class="problematic" id="id66">``</span></a><a href="#id67"><span class="problematic" id="id68">`</span></a>{.k .uiuck .rvk}</dt>
<dd>syntax Mode ::= “NORMAL” | “VMTESTS”</dd>
</dl>
<p><a href="#id69"><span class="problematic" id="id70">``</span></a><a href="#id71"><span class="problematic" id="id72">`</span></a></p>
<ul class="simple">
<li><cite>#setMode_</cite> sets the mode to the supplied one.</li>
</ul>
<dl class="docutils">
<dt><a href="#id73"><span class="problematic" id="id74">``</span></a><a href="#id75"><span class="problematic" id="id76">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Mode ::= “#setMode” Mode</div></blockquote>
<dl class="last docutils">
<dt>// ——————————-</dt>
<dd>rule &lt;k&gt; #setMode EXECMODE =&gt; . … &lt;/k&gt; &lt;mode&gt; _ =&gt; EXECMODE &lt;/mode&gt;
rule &lt;k&gt; EX:Exception ~&gt; (#setMode _ =&gt; .) … &lt;/k&gt;</dd>
</dl>
</dd>
</dl>
<p><a href="#id77"><span class="problematic" id="id78">``</span></a><a href="#id79"><span class="problematic" id="id80">`</span></a></p>
</div>
<div class="section" id="hardware">
<h2>Hardware<a class="headerlink" href="#hardware" title="Permalink to this headline">¶</a></h2>
<p>The <cite>callStack</cite> cell stores a list of previous VM execution states.</p>
<ul class="simple">
<li><cite>#pushCallStack</cite> saves a copy of VM execution state on the <cite>callStack</cite>.</li>
<li><cite>#popCallStack</cite> restores the top element of the <cite>callStack</cite>.</li>
<li><cite>#dropCallStack</cite> removes the top element of the <cite>callStack</cite>.</li>
</ul>
<dl class="docutils">
<dt><a href="#id81"><span class="problematic" id="id82">``</span></a><a href="#id83"><span class="problematic" id="id84">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax State ::= “{” Int “|” Int “|” Map “|” WordStack “|” Int “|” WordStack “|” Int “|” WordStack “|” Map “|” Int “|” Int “|” Int “}”</div></blockquote>
<p>// ————————————————————————————————————————————–</p>
<blockquote>
<div>syntax InternalOp ::= “#pushCallStack”</div></blockquote>
<dl class="last docutils">
<dt>// ————————————–</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; #pushCallStack =&gt; . … &lt;/k&gt;</dt>
<dd>&lt;callStack&gt;  (.List =&gt; ListItem({ ACCT | GAVAIL | PGM | BYTES | CR | CD | CV | WS | LM | MUSED | PCOUNT | DEPTH })) … &lt;/callStack&gt;
&lt;id&gt;           ACCT   &lt;/id&gt;
&lt;gas&gt;          GAVAIL &lt;/gas&gt;
&lt;program&gt;      PGM    &lt;/program&gt;
&lt;programBytes&gt; BYTES  &lt;/programBytes&gt;
&lt;caller&gt;       CR     &lt;/caller&gt;
&lt;callData&gt;     CD     &lt;/callData&gt;
&lt;callValue&gt;    CV     &lt;/callValue&gt;
&lt;wordStack&gt;    WS     &lt;/wordStack&gt;
&lt;localMem&gt;     LM     &lt;/localMem&gt;
&lt;memoryUsed&gt;   MUSED  &lt;/memoryUsed&gt;
&lt;pc&gt;           PCOUNT &lt;/pc&gt;
&lt;callDepth&gt;    DEPTH  &lt;/callDepth&gt;</dd>
</dl>
<p class="last">syntax InternalOp ::= “#popCallStack”</p>
</dd>
<dt>// ————————————-</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; #popCallStack =&gt; . … &lt;/k&gt;</dt>
<dd>&lt;callStack&gt;  (ListItem({ ACCT | GAVAIL | PGM | BYTES | CR | CD | CV | WS | LM | MUSED | PCOUNT | DEPTH }) =&gt; .List) … &lt;/callStack&gt;
&lt;id&gt;           _ =&gt; ACCT   &lt;/id&gt;
&lt;gas&gt;          _ =&gt; GAVAIL &lt;/gas&gt;
&lt;program&gt;      _ =&gt; PGM    &lt;/program&gt;
&lt;programBytes&gt; _ =&gt; BYTES  &lt;/programBytes&gt;
&lt;caller&gt;       _ =&gt; CR     &lt;/caller&gt;
&lt;callData&gt;     _ =&gt; CD     &lt;/callData&gt;
&lt;callValue&gt;    _ =&gt; CV     &lt;/callValue&gt;
&lt;wordStack&gt;    _ =&gt; WS     &lt;/wordStack&gt;
&lt;localMem&gt;     _ =&gt; LM     &lt;/localMem&gt;
&lt;memoryUsed&gt;   _ =&gt; MUSED  &lt;/memoryUsed&gt;
&lt;pc&gt;           _ =&gt; PCOUNT &lt;/pc&gt;
&lt;callDepth&gt;    _ =&gt; DEPTH  &lt;/callDepth&gt;</dd>
</dl>
<p class="last">syntax InternalOp ::= “#dropCallStack”</p>
</dd>
<dt>// ————————————–</dt>
<dd>rule &lt;k&gt; #dropCallStack =&gt; . … &lt;/k&gt; &lt;callStack&gt; (ListItem(_) =&gt; .List) … &lt;/callStack&gt;</dd>
</dl>
</dd>
</dl>
<p><a href="#id85"><span class="problematic" id="id86">``</span></a><a href="#id87"><span class="problematic" id="id88">`</span></a></p>
<p>The <cite>interimStates</cite> cell stores a list of previous world states.</p>
<ul class="simple">
<li><cite>#pushWorldState</cite> stores a copy of the current accounts at the top of the <cite>interimStates</cite> cell.</li>
<li><cite>#popWorldState</cite> restores the top element of the <cite>interimStates</cite>.</li>
<li><cite>#dropWorldState</cite> removes the top element of the <cite>interimStates</cite>.</li>
</ul>
<p>We use slightly different rules for rv-k versus uiuc-k because uiuc-k does not support storing configuration fragments.
The semantics of these two sets of rules are identical, however, the version rv-k uses is substantially faster.
We would use that version in both places if not for technical limitations on the prover.
In the long term, a new prover will be built capable of supporting the same code in both versions of the semantics.</p>
<dl class="docutils">
<dt><a href="#id89"><span class="problematic" id="id90">``</span></a><a href="#id91"><span class="problematic" id="id92">`</span></a>{.k .uiuck}</dt>
<dd><blockquote class="first">
<div>syntax Account ::= “{” Int “|” Int “|” WordStack “|” Map “|” Int “|” Bool “}”</div></blockquote>
<p>// —————————————————————————–</p>
<blockquote>
<div>syntax InternalOp ::= “#pushWorldState” | “#pushWorldStateAux” Map | “#pushAccount” Int Bool</div></blockquote>
<dl class="last docutils">
<dt>// ——————————————————————————————–</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; #pushWorldState =&gt; #pushWorldStateAux ACCTS … &lt;/k&gt;</dt>
<dd>&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;
&lt;interimStates&gt; (.List =&gt; ListItem(.Set)) … &lt;/interimStates&gt;</dd>
</dl>
<p>rule &lt;k&gt; #pushWorldStateAux .Map =&gt; . … &lt;/k&gt;
rule &lt;k&gt; #pushWorldStateAux ((ACCT <a href="#id93"><span class="problematic" id="id94">|</span></a>-&gt; EMPTY) REST) =&gt; #pushAccount ACCT EMPTY ~&gt; #pushWorldStateAux REST … &lt;/k&gt;
rule &lt;k&gt; #pushAccount ACCT EMPTY =&gt; . … &lt;/k&gt;</p>
<blockquote>
<div><p>&lt;interimStates&gt; ListItem((.Set =&gt; SetItem({ ACCT | BAL | CODE | STORAGE | NONCE | EMPTY })) REST) … &lt;/interimStates&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;balance&gt; BAL &lt;/balance&gt;
&lt;code&gt; CODE &lt;/code&gt;
&lt;storage&gt; STORAGE &lt;/storage&gt;
&lt;nonce&gt; NONCE &lt;/nonce&gt;</div></blockquote>
<p>&lt;/account&gt;</p>
</div></blockquote>
<p class="last">syntax InternalOp ::= “#popWorldState” | “#popWorldStateAux” Set</p>
</dd>
<dt>// —————————————————————-</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; #popWorldState =&gt; #popWorldStateAux PREVSTATE … &lt;/k&gt;</dt>
<dd>&lt;interimStates&gt; (ListItem(PREVSTATE) =&gt; .List) … &lt;/interimStates&gt;
&lt;activeAccounts&gt; _ =&gt; .Map &lt;/activeAccounts&gt;
&lt;accounts&gt; _ =&gt; .Bag &lt;/accounts&gt;</dd>
</dl>
<p>rule &lt;k&gt; #popWorldStateAux .Set =&gt; . … &lt;/k&gt;
rule &lt;k&gt; #popWorldStateAux ( (SetItem({ ACCT | BAL | CODE | STORAGE | NONCE | EMPTY }) =&gt; .Set) REST ) … &lt;/k&gt;</p>
<blockquote>
<div><p>&lt;activeAccounts&gt; … (.Map =&gt; ACCT <a href="#id95"><span class="problematic" id="id96">|</span></a>-&gt; EMPTY) &lt;/activeAccounts&gt;
&lt;accounts&gt; ( .Bag</p>
<blockquote>
<div><dl class="docutils">
<dt>=&gt; &lt;account&gt;</dt>
<dd><blockquote class="first last">
<div><blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;balance&gt; BAL &lt;/balance&gt;
&lt;code&gt; CODE &lt;/code&gt;
&lt;storage&gt; STORAGE &lt;/storage&gt;
&lt;nonce&gt; NONCE &lt;/nonce&gt;</div></blockquote>
<p>&lt;/account&gt;</p>
</div></blockquote>
</dd>
</dl>
</div></blockquote>
<p>&lt;/accounts&gt;</p>
</div></blockquote>
<p class="last">syntax InternalOp ::= “#dropWorldState”</p>
</dd>
<dt>// —————————————</dt>
<dd>rule &lt;k&gt; #dropWorldState =&gt; . … &lt;/k&gt; &lt;interimStates&gt; (ListItem(_) =&gt; .List) … &lt;/interimStates&gt;</dd>
</dl>
</dd>
</dl>
<p><a href="#id97"><span class="problematic" id="id98">``</span></a><a href="#id99"><span class="problematic" id="id100">`</span></a></p>
<dl class="docutils">
<dt><a href="#id101"><span class="problematic" id="id102">``</span></a><a href="#id103"><span class="problematic" id="id104">`</span></a>{.k .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Accounts ::= “{” AccountsCell “|” Map “}”</div></blockquote>
<p>// ————————————————</p>
<blockquote>
<div>syntax InternalOp ::= “#pushWorldState”</div></blockquote>
<dl class="last docutils">
<dt>// —————————————</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; #pushWorldState =&gt; .K … &lt;/k&gt;</dt>
<dd>&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;
&lt;accounts&gt; ACCTDATA &lt;/accounts&gt;
&lt;interimStates&gt; (.List =&gt; ListItem({ &lt;accounts&gt; ACCTDATA &lt;/accounts&gt; | ACCTS })) … &lt;/interimStates&gt;</dd>
</dl>
<p class="last">syntax InternalOp ::= “#popWorldState”</p>
</dd>
<dt>// ————————————–</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; #popWorldState =&gt; .K … &lt;/k&gt;</dt>
<dd>&lt;interimStates&gt; (ListItem({ &lt;accounts&gt; ACCTDATA &lt;/accounts&gt; | ACCTS }) =&gt; .List) … &lt;/interimStates&gt;
&lt;activeAccounts&gt; _ =&gt; ACCTS &lt;/activeAccounts&gt;
&lt;accounts&gt; _ =&gt; ACCTDATA &lt;/accounts&gt;</dd>
</dl>
<p class="last">syntax InternalOp ::= “#dropWorldState”</p>
</dd>
<dt>// —————————————</dt>
<dd>rule &lt;k&gt; #dropWorldState =&gt; . … &lt;/k&gt; &lt;interimStates&gt; (ListItem(_) =&gt; .List) … &lt;/interimStates&gt;</dd>
</dl>
</dd>
</dl>
<p><a href="#id105"><span class="problematic" id="id106">``</span></a><a href="#id107"><span class="problematic" id="id108">`</span></a></p>
<p>The <cite>substateStack</cite> cell stores a list of previous substate logs.</p>
<ul class="simple">
<li><cite>#pushSubstate</cite> stores a copy of the current substate at the top of the <cite>substateStack</cite> cell.</li>
<li><cite>#popSubstate</cite> restores the top element of the <cite>substateStack</cite>.</li>
<li><cite>#dropSubstate</cite> removes the top element of the <cite>substateStack</cite>.</li>
</ul>
<dl class="docutils">
<dt><a href="#id109"><span class="problematic" id="id110">``</span></a><a href="#id111"><span class="problematic" id="id112">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= “#pushSubstate”</div></blockquote>
<dl class="last docutils">
<dt>// ————————————-</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; #pushSubstate =&gt; .K … &lt;/k&gt;</dt>
<dd>&lt;substate&gt; SUBSTATE &lt;/substate&gt;
&lt;substateStack&gt; (.List =&gt; ListItem(&lt;substate&gt; SUBSTATE &lt;/substate&gt;)) … &lt;/substateStack&gt;</dd>
</dl>
<p class="last">syntax InternalOp ::= “#popSubstate”</p>
</dd>
<dt>// ————————————</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; #popSubstate =&gt; .K … &lt;/k&gt;</dt>
<dd>&lt;substate&gt; _ =&gt; SUBSTATE &lt;/substate&gt;
&lt;substateStack&gt; (ListItem(&lt;substate&gt; SUBSTATE &lt;/substate&gt;) =&gt; .List) … &lt;/substateStack&gt;</dd>
</dl>
<p class="last">syntax InternalOp ::= “#dropSubstate”</p>
</dd>
<dt>// ————————————-</dt>
<dd>rule &lt;k&gt; #dropSubstate =&gt; .K … &lt;/k&gt; &lt;substateStack&gt; (ListItem(_) =&gt; .List) … &lt;/substateStack&gt;</dd>
</dl>
</dd>
</dl>
<p><a href="#id113"><span class="problematic" id="id114">``</span></a><a href="#id115"><span class="problematic" id="id116">`</span></a></p>
<p>Simple commands controlling exceptions provide control-flow.</p>
<ul class="simple">
<li><cite>#end</cite> is used to indicate the (non-exceptional) end of execution.</li>
<li><cite>#exception</cite> is used to indicate exceptional states (it consumes any operations to be performed after it).</li>
<li><cite>#?_:_?#</cite> allows for branching control-flow; if it reaches the front of the <cite>op</cite> cell it takes the first branch, if an exception runs into it it takes the second branch.</li>
</ul>
<dl class="docutils">
<dt><a href="#id117"><span class="problematic" id="id118">``</span></a><a href="#id119"><span class="problematic" id="id120">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax KItem ::= Exception
syntax Exception ::= “#exception” | “#end”</div></blockquote>
<dl class="last docutils">
<dt>// ——————————————</dt>
<dd><p class="first">rule &lt;k&gt; EX:Exception ~&gt; (_:Int    =&gt; .) … &lt;/k&gt;
rule &lt;k&gt; EX:Exception ~&gt; (_:OpCode =&gt; .) … &lt;/k&gt;</p>
<p class="last">syntax KItem ::= “#?” K “:” K “?#”</p>
</dd>
<dt>// ———————————-</dt>
<dd>rule &lt;k&gt;                #? K : _ ?#  =&gt; K         … &lt;/k&gt;
rule &lt;k&gt; #exception ~&gt;  #? _ : K ?#  =&gt; K         … &lt;/k&gt;
rule &lt;k&gt; #end       ~&gt; (#? K : _ ?#) =&gt; K ~&gt; #end … &lt;/k&gt;</dd>
</dl>
</dd>
</dl>
<p><a href="#id121"><span class="problematic" id="id122">``</span></a><a href="#id123"><span class="problematic" id="id124">`</span></a></p>
</div>
<div class="section" id="opcode-execution-cycle">
<h2>OpCode Execution Cycle<a class="headerlink" href="#opcode-execution-cycle" title="Permalink to this headline">¶</a></h2>
<p><cite>OpCode</cite> is broken into several subsorts for easier handling.
Here all <cite>OpCode`s are subsorted into `KItem</cite> (allowing sequentialization), and the various sorts of opcodes are subsorted into <cite>OpCode</cite>.</p>
<dl class="docutils">
<dt><a href="#id125"><span class="problematic" id="id126">``</span></a><a href="#id127"><span class="problematic" id="id128">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div><p>syntax KItem  ::= OpCode
syntax OpCode ::= NullStackOp | UnStackOp | BinStackOp | TernStackOp | QuadStackOp</p>
<blockquote>
<div><div class="line-block">
<div class="line">InvalidOp | StackOp | InternalOp | CallOp | CallSixOp | PushOp</div>
</div>
</div></blockquote>
</div></blockquote>
<p class="last">// ——————————————————————————–</p>
</dd>
</dl>
<p><a href="#id129"><span class="problematic" id="id130">``</span></a><a href="#id131"><span class="problematic" id="id132">`</span></a></p>
<ul class="simple">
<li><cite>#execute</cite> calls <cite>#next</cite> repeatedly until it recieves an <cite>#end</cite> or <cite>#exception</cite>.</li>
<li><cite>#execTo</cite> executes until the next opcode is one of the specified ones.</li>
</ul>
<dl class="docutils">
<dt><a href="#id133"><span class="problematic" id="id134">``</span></a><a href="#id135"><span class="problematic" id="id136">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax KItem ::= “#execute”</div></blockquote>
<dl class="last docutils">
<dt>// —————————</dt>
<dd><p class="first">rule &lt;k&gt; (. =&gt; #next) ~&gt; #execute … &lt;/k&gt;
rule &lt;k&gt; EX:Exception ~&gt; (#execute =&gt; .)  … &lt;/k&gt;</p>
<p class="last">syntax InternalOp ::= “#execTo” Set</p>
</dd>
<dt>// ———————————–</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; (. =&gt; #next) ~&gt; #execTo OPS … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;pc&gt; PCOUNT &lt;/pc&gt;
&lt;program&gt; … PCOUNT <a href="#id137"><span class="problematic" id="id138">|</span></a>-&gt; OP … &lt;/program&gt;</div></blockquote>
<p class="last">requires notBool (OP in OPS)</p>
</dd>
<dt>rule &lt;k&gt; #execTo OPS =&gt; . … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;pc&gt; PCOUNT &lt;/pc&gt;
&lt;program&gt; … PCOUNT <a href="#id139"><span class="problematic" id="id140">|</span></a>-&gt; OP … &lt;/program&gt;</div></blockquote>
<p class="last">requires OP in OPS</p>
</dd>
<dt>rule &lt;k&gt; #execTo OPS =&gt; #end … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;pc&gt; PCOUNT &lt;/pc&gt;
&lt;program&gt; PGM &lt;/program&gt;</div></blockquote>
<p class="last">requires notBool PCOUNT in keys(PGM)</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id141"><span class="problematic" id="id142">``</span></a><a href="#id143"><span class="problematic" id="id144">`</span></a></p>
<p>Execution follows a simple cycle where first the state is checked for exceptions, then if no exceptions will be thrown the opcode is run.</p>
<ul class="simple">
<li>Regardless of the mode, <cite>#next</cite> will throw <cite>#end</cite> or <cite>#exception</cite> if the current program counter is not pointing at an OpCode.</li>
</ul>
<p>TODO: I think on <cite>#next</cite> we are supposed to pretend it’s <cite>STOP</cite> if it’s in the middle of the program somewhere but is invalid?
I suppose the semantics currently loads <cite>INVALID</cite> where <cite>N</cite> is the position in the bytecode array.</p>
<dl class="docutils">
<dt><a href="#id145"><span class="problematic" id="id146">``</span></a><a href="#id147"><span class="problematic" id="id148">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= “#next”</div></blockquote>
<dl class="last docutils">
<dt>// —————————–</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; #next =&gt; #end … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;pc&gt; PCOUNT &lt;/pc&gt;
&lt;program&gt; PGM &lt;/program&gt;</div></blockquote>
<p class="last">requires notBool (PCOUNT in_keys(PGM))</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id149"><span class="problematic" id="id150">``</span></a><a href="#id151"><span class="problematic" id="id152">`</span></a></p>
<ul class="simple">
<li>In <cite>NORMAL</cite> or <cite>VMTESTS</cite> mode, <cite>#next</cite> checks if the opcode is exceptional, runs it if not, then increments the program counter.</li>
</ul>
<dl class="docutils">
<dt><a href="#id153"><span class="problematic" id="id154">``</span></a><a href="#id155"><span class="problematic" id="id156">`</span></a>{.k .uiuck .rvk}</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;mode&gt; EXECMODE &lt;/mode&gt;</dt>
<dd><blockquote class="first">
<div><dl class="docutils">
<dt>&lt;k&gt; #next</dt>
<dd>=&gt; #pushCallStack
~&gt; #exceptional? [ OP ] ~&gt; #exec [ OP ] ~&gt; #pc [ OP ]
~&gt; #? #dropCallStack : #popCallStack ~&gt; #exception ?#</dd>
</dl>
<p>…
&lt;/k&gt;
&lt;pc&gt; PCOUNT &lt;/pc&gt;
&lt;program&gt; … PCOUNT <a href="#id157"><span class="problematic" id="id158">|</span></a>-&gt; OP … &lt;/program&gt;</p>
</div></blockquote>
<p class="last">requires EXECMODE in (SetItem(NORMAL) SetItem(VMTESTS))</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id159"><span class="problematic" id="id160">``</span></a><a href="#id161"><span class="problematic" id="id162">`</span></a></p>
<p>### Exceptional OpCodes</p>
<p>Some checks if an opcode will throw an exception are relatively quick and done up front.</p>
<ul class="simple">
<li><cite>#exceptional?</cite> checks if the operator is invalid and will not cause <cite>wordStack</cite> size issues (this implements the function <cite>Z</cite> in the yellowpaper, section 9.4.2).</li>
</ul>
<dl class="docutils">
<dt><a href="#id163"><span class="problematic" id="id164">``</span></a><a href="#id165"><span class="problematic" id="id166">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= “#exceptional?” “[” OpCode “]”</div></blockquote>
<dl class="last docutils">
<dt>// —————————————————-</dt>
<dd>rule &lt;k&gt; #exceptional? [ OP ] =&gt; #invalid? [ OP ] ~&gt; #stackNeeded? [ OP ] ~&gt; #badJumpDest? [ OP ] … &lt;/k&gt;</dd>
</dl>
</dd>
</dl>
<p><a href="#id167"><span class="problematic" id="id168">``</span></a><a href="#id169"><span class="problematic" id="id170">`</span></a></p>
<ul class="simple">
<li><cite>#invalid?</cite> checks if it’s the designated invalid opcode.</li>
</ul>
<dl class="docutils">
<dt><a href="#id171"><span class="problematic" id="id172">``</span></a><a href="#id173"><span class="problematic" id="id174">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= “#invalid?” “[” OpCode “]”</div></blockquote>
<dl class="last docutils">
<dt>// ————————————————</dt>
<dd>rule &lt;k&gt; #invalid? [ INVALID ] =&gt; #exception … &lt;/k&gt;
rule &lt;k&gt; #invalid? [ OP      ] =&gt; .          … &lt;/k&gt; requires notBool isInvalidOp(OP)</dd>
</dl>
</dd>
</dl>
<p><a href="#id175"><span class="problematic" id="id176">``</span></a><a href="#id177"><span class="problematic" id="id178">`</span></a></p>
<ul class="simple">
<li><cite>#stackNeeded?</cite> checks that the stack will be not be under/overflown.</li>
<li><cite>#stackNeeded</cite>, <cite>#stackAdded</cite>, and <cite>#stackDelta</cite> are helpers for deciding <cite>#stackNeeded?</cite>.</li>
</ul>
<dl class="docutils">
<dt><a href="#id179"><span class="problematic" id="id180">``</span></a><a href="#id181"><span class="problematic" id="id182">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= “#stackNeeded?” “[” OpCode “]”</div></blockquote>
<dl class="last docutils">
<dt>// —————————————————-</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; #stackNeeded? [ OP ] =&gt; #exception … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;wordStack&gt; WS &lt;/wordStack&gt;</div></blockquote>
<dl class="last docutils">
<dt>requires #sizeWordStack(WS) &lt;Int #stackNeeded(OP)</dt>
<dd>orBool #sizeWordStack(WS) +Int #stackDelta(OP) &gt;Int 1024</dd>
</dl>
</dd>
<dt>rule &lt;k&gt; #stackNeeded? [ OP ] =&gt; .K … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;wordStack&gt; WS &lt;/wordStack&gt;</div></blockquote>
<dl class="last docutils">
<dt>requires notBool (#sizeWordStack(WS) &lt;Int #stackNeeded(OP)</dt>
<dd>orBool   #sizeWordStack(WS) +Int #stackDelta(OP) &gt;Int 1024)</dd>
</dl>
</dd>
</dl>
<p class="last">syntax Int ::= #stackNeeded ( OpCode ) [function]</p>
</dd>
<dt>// ————————————————-</dt>
<dd><p class="first">rule #stackNeeded(PUSH(_, _))      =&gt; 0
rule #stackNeeded(NOP:NullStackOp) =&gt; 0
rule #stackNeeded(UOP:UnStackOp)   =&gt; 1
rule #stackNeeded(BOP:BinStackOp)  =&gt; 2 requires notBool isLogOp(BOP)
rule #stackNeeded(TOP:TernStackOp) =&gt; 3
rule #stackNeeded(QOP:QuadStackOp) =&gt; 4
rule #stackNeeded(DUP(N))          =&gt; N
rule #stackNeeded(SWAP(N))         =&gt; N +Int 1
rule #stackNeeded(LOG(N))          =&gt; N +Int 2
rule #stackNeeded(DELEGATECALL)    =&gt; 6
rule #stackNeeded(COP:CallOp)      =&gt; 7 requires COP =/=K DELEGATECALL</p>
<p class="last">syntax Int ::= #stackAdded ( OpCode ) [function]</p>
</dd>
<dt>// ————————————————</dt>
<dd><p class="first">rule #stackAdded(CALLDATACOPY) =&gt; 0
rule #stackAdded(CODECOPY)     =&gt; 0
rule #stackAdded(EXTCODECOPY)  =&gt; 0
rule #stackAdded(POP)          =&gt; 0
rule #stackAdded(MSTORE)       =&gt; 0
rule #stackAdded(MSTORE8)      =&gt; 0
rule #stackAdded(SSTORE)       =&gt; 0
rule #stackAdded(JUMP)         =&gt; 0
rule #stackAdded(JUMPI)        =&gt; 0
rule #stackAdded(JUMPDEST)     =&gt; 0
rule #stackAdded(STOP)         =&gt; 0
rule #stackAdded(RETURN)       =&gt; 0
rule #stackAdded(SELFDESTRUCT) =&gt; 0
rule #stackAdded(PUSH(_,_))    =&gt; 1
rule #stackAdded(LOG(_))       =&gt; 0
rule #stackAdded(SWAP(N))      =&gt; N
rule #stackAdded(DUP(N))       =&gt; N +Int 1
rule #stackAdded(OP)           =&gt; 1 [owise]</p>
<p class="last">syntax Int ::= #stackDelta ( OpCode ) [function]</p>
</dd>
<dt>// ————————————————</dt>
<dd>rule #stackDelta(OP) =&gt; #stackAdded(OP) -Int #stackNeeded(OP)</dd>
</dl>
</dd>
</dl>
<p><a href="#id183"><span class="problematic" id="id184">``</span></a><a href="#id185"><span class="problematic" id="id186">`</span></a></p>
<ul class="simple">
<li><cite>#badJumpDest?</cite> determines if the opcode will result in a bad jump destination.</li>
</ul>
<dl class="docutils">
<dt><a href="#id187"><span class="problematic" id="id188">``</span></a><a href="#id189"><span class="problematic" id="id190">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= “#badJumpDest?” “[” OpCode “]”</div></blockquote>
<dl class="last docutils">
<dt>// —————————————————-</dt>
<dd><p class="first">rule &lt;k&gt; #badJumpDest? [ OP    ] =&gt; . … &lt;/k&gt; requires notBool isJumpOp(OP)
rule &lt;k&gt; #badJumpDest? [ OP    ] =&gt; . … &lt;/k&gt; &lt;wordStack&gt; DEST  : WS &lt;/wordStack&gt; &lt;program&gt; … DEST <a href="#id191"><span class="problematic" id="id192">|</span></a>-&gt; JUMPDEST … &lt;/program&gt; requires isJumpOp(OP)
rule &lt;k&gt; #badJumpDest? [ JUMPI ] =&gt; . … &lt;/k&gt; &lt;wordStack&gt; _ : 0 : WS &lt;/wordStack&gt;</p>
<p>rule &lt;k&gt; #badJumpDest? [ JUMP  ] =&gt; #exception … &lt;/k&gt; &lt;wordStack&gt; DEST :     WS &lt;/wordStack&gt; &lt;program&gt; … DEST <a href="#id193"><span class="problematic" id="id194">|</span></a>-&gt; OP … &lt;/program&gt; requires OP =/=K JUMPDEST
rule &lt;k&gt; #badJumpDest? [ JUMPI ] =&gt; #exception … &lt;/k&gt; &lt;wordStack&gt; DEST : W : WS &lt;/wordStack&gt; &lt;program&gt; … DEST <a href="#id195"><span class="problematic" id="id196">|</span></a>-&gt; OP … &lt;/program&gt; requires OP =/=K JUMPDEST andBool W =/=K 0</p>
<p class="last">rule &lt;k&gt; #badJumpDest? [ JUMP  ] =&gt; #exception … &lt;/k&gt; &lt;wordStack&gt; DEST :     WS &lt;/wordStack&gt; &lt;program&gt; PGM &lt;/program&gt; requires notBool (DEST in_keys(PGM))
rule &lt;k&gt; #badJumpDest? [ JUMPI ] =&gt; #exception … &lt;/k&gt; &lt;wordStack&gt; DEST : W : WS &lt;/wordStack&gt; &lt;program&gt; PGM &lt;/program&gt; requires (notBool (DEST in_keys(PGM))) andBool W =/=K 0</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id197"><span class="problematic" id="id198">``</span></a><a href="#id199"><span class="problematic" id="id200">`</span></a></p>
<p>### Execution Step</p>
<ul class="simple">
<li><cite>#exec</cite> will load the arguments of the opcode (it assumes <cite>#stackNeeded?</cite> is accurate and has been called) and trigger the subsequent operations.</li>
</ul>
<dl class="docutils">
<dt><a href="#id201"><span class="problematic" id="id202">``</span></a><a href="#id203"><span class="problematic" id="id204">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= “#exec” “[” OpCode “]”</div></blockquote>
<dl class="last docutils">
<dt>// ——————————————–</dt>
<dd>rule &lt;k&gt; #exec [ OP ] =&gt; #gas [ OP ] ~&gt; OP … &lt;/k&gt; requires isInternalOp(OP) orBool isNullStackOp(OP) orBool isPushOp(OP)</dd>
</dl>
</dd>
</dl>
<p><a href="#id205"><span class="problematic" id="id206">``</span></a><a href="#id207"><span class="problematic" id="id208">`</span></a></p>
<p>Here we load the correct number of arguments from the <cite>wordStack</cite> based on the sort of the opcode.
Some of them require an argument to be interpereted as an address (modulo 160 bits), so the <cite>#addr?</cite> function performs that check.</p>
<dl class="docutils">
<dt><a href="#id209"><span class="problematic" id="id210">``</span></a><a href="#id211"><span class="problematic" id="id212">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div><dl class="docutils">
<dt>syntax InternalOp ::= UnStackOp Int</dt>
<dd><div class="first last line-block">
<div class="line">BinStackOp Int Int</div>
<div class="line">TernStackOp Int Int Int</div>
<div class="line">QuadStackOp Int Int Int Int</div>
</div>
</dd>
</dl>
</div></blockquote>
<dl class="last docutils">
<dt>// ————————————————-</dt>
<dd><p class="first">rule &lt;k&gt; #exec [ UOP:UnStackOp   =&gt; UOP #addr?(UOP, W0)          ] … &lt;/k&gt; &lt;wordStack&gt; W0 : WS                =&gt; WS &lt;/wordStack&gt;
rule &lt;k&gt; #exec [ BOP:BinStackOp  =&gt; BOP #addr?(BOP, W0) W1       ] … &lt;/k&gt; &lt;wordStack&gt; W0 : W1 : WS           =&gt; WS &lt;/wordStack&gt;
rule &lt;k&gt; #exec [ TOP:TernStackOp =&gt; TOP #addr?(TOP, W0) W1 W2    ] … &lt;/k&gt; &lt;wordStack&gt; W0 : W1 : W2 : WS      =&gt; WS &lt;/wordStack&gt;
rule &lt;k&gt; #exec [ QOP:QuadStackOp =&gt; QOP #addr?(QOP, W0) W1 W2 W3 ] … &lt;/k&gt; &lt;wordStack&gt; W0 : W1 : W2 : W3 : WS =&gt; WS &lt;/wordStack&gt;</p>
<p class="last">syntax Int ::= “#addr?” “(” OpCode “,” Int “)” [function]</p>
</dd>
<dt>// ———————————————————</dt>
<dd>rule #addr?(BALANCE,      W) =&gt; #addr(W)
rule #addr?(EXTCODESIZE,  W) =&gt; #addr(W)
rule #addr?(EXTCODECOPY,  W) =&gt; #addr(W)
rule #addr?(SELFDESTRUCT, W) =&gt; #addr(W)
rule #addr?(OP, W)           =&gt; W        requires (OP =/=K BALANCE) andBool (OP =/=K EXTCODESIZE) andBool (OP =/=K EXTCODECOPY) andBool (OP =/=K SELFDESTRUCT)</dd>
</dl>
</dd>
</dl>
<p><a href="#id213"><span class="problematic" id="id214">``</span></a><a href="#id215"><span class="problematic" id="id216">`</span></a></p>
<p><cite>StackOp</cite> is used for opcodes which require a large portion of the stack.</p>
<dl class="docutils">
<dt><a href="#id217"><span class="problematic" id="id218">``</span></a><a href="#id219"><span class="problematic" id="id220">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= StackOp WordStack</div></blockquote>
<dl class="last docutils">
<dt>// —————————————</dt>
<dd>rule &lt;k&gt; #exec [ SO:StackOp =&gt; SO WS ] … &lt;/k&gt; &lt;wordStack&gt; WS &lt;/wordStack&gt;</dd>
</dl>
</dd>
</dl>
<p><a href="#id221"><span class="problematic" id="id222">``</span></a><a href="#id223"><span class="problematic" id="id224">`</span></a></p>
<p>The <cite>CallOp</cite> opcodes all interperet their second argument as an address.</p>
<dl class="docutils">
<dt><a href="#id225"><span class="problematic" id="id226">``</span></a><a href="#id227"><span class="problematic" id="id228">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div><dl class="docutils">
<dt>syntax InternalOp ::= CallSixOp Int Int     Int Int Int Int</dt>
<dd><div class="first last line-block">
<div class="line">CallOp    Int Int Int Int Int Int Int</div>
</div>
</dd>
</dl>
</div></blockquote>
<dl class="last docutils">
<dt>// ———————————————————–</dt>
<dd>rule &lt;k&gt; #exec [ CSO:CallSixOp =&gt; CSO W0 #addr(W1)    W2 W3 W4 W5 ] … &lt;/k&gt; &lt;wordStack&gt; W0 : W1 : W2 : W3 : W4 : W5 : WS      =&gt; WS &lt;/wordStack&gt;
rule &lt;k&gt; #exec [ CO:CallOp     =&gt; CO  W0 #addr(W1) W2 W3 W4 W5 W6 ] … &lt;/k&gt; &lt;wordStack&gt; W0 : W1 : W2 : W3 : W4 : W5 : W6 : WS =&gt; WS &lt;/wordStack&gt;</dd>
</dl>
</dd>
</dl>
<p><a href="#id229"><span class="problematic" id="id230">``</span></a><a href="#id231"><span class="problematic" id="id232">`</span></a></p>
<ul class="simple">
<li><cite>#gas</cite> calculates how much gas this operation costs, and takes into account the memory consumed.</li>
</ul>
<dl class="docutils">
<dt><a href="#id233"><span class="problematic" id="id234">``</span></a><a href="#id235"><span class="problematic" id="id236">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= “#gas” “[” OpCode “]” | “#deductGas” | “#deductMemory”</div></blockquote>
<dl class="last docutils">
<dt>// —————————————————————————-</dt>
<dd><p class="first">rule &lt;k&gt; #gas [ OP ] =&gt; #memory(OP, MU) ~&gt; #deductMemory ~&gt; #gasExec(SCHED, OP) ~&gt; #deductGas … &lt;/k&gt; &lt;memoryUsed&gt; MU &lt;/memoryUsed&gt; &lt;schedule&gt; SCHED &lt;/schedule&gt;</p>
<p>rule &lt;k&gt; MU’:Int ~&gt; #deductMemory =&gt; #exception … &lt;/k&gt; requires MU’ &gt;=Int pow256
rule &lt;k&gt; MU’:Int ~&gt; #deductMemory =&gt; (Cmem(SCHED, MU’) -Int Cmem(SCHED, MU)) ~&gt; #deductGas … &lt;/k&gt;</p>
<blockquote>
<div><blockquote>
<div>&lt;memoryUsed&gt; MU =&gt; MU’ &lt;/memoryUsed&gt; &lt;schedule&gt; SCHED &lt;/schedule&gt;</div></blockquote>
<p>requires MU’ &lt;Int pow256</p>
</div></blockquote>
<p>rule &lt;k&gt; G:Int ~&gt; #deductGas =&gt; #exception … &lt;/k&gt; &lt;gas&gt; GAVAIL                  &lt;/gas&gt; requires GAVAIL &lt;Int G
rule &lt;k&gt; G:Int ~&gt; #deductGas =&gt; .          … &lt;/k&gt; &lt;gas&gt; GAVAIL =&gt; GAVAIL -Int G &lt;/gas&gt; &lt;previousGas&gt; _ =&gt; GAVAIL &lt;/previousGas&gt; requires GAVAIL &gt;=Int G</p>
<p class="last">syntax Int ::= Cmem ( Schedule , Int ) [function, memo]</p>
</dd>
<dt>// ——————————————————-</dt>
<dd>rule Cmem(SCHED, N) =&gt; (N <a href="#id237"><span class="problematic" id="id238">*</span></a>Int Gmemory &lt; SCHED &gt;) +Int ((N <a href="#id239"><span class="problematic" id="id240">*</span></a>Int N) /Int Gquadcoeff &lt; SCHED &gt;)</dd>
</dl>
</dd>
</dl>
<p><a href="#id241"><span class="problematic" id="id242">``</span></a><a href="#id243"><span class="problematic" id="id244">`</span></a></p>
<p>### Program Counter</p>
<p>All operators except for <cite>PUSH</cite> and <cite>JUMP*</cite> increment the program counter by 1.
The arguments to <cite>PUSH</cite> must be skipped over (as they are inline), and the opcode <cite>JUMP</cite> already affects the program counter in the correct way.</p>
<ul class="simple">
<li><cite>#pc</cite> calculates the next program counter of the given operator.</li>
</ul>
<dl class="docutils">
<dt><a href="#id245"><span class="problematic" id="id246">``</span></a><a href="#id247"><span class="problematic" id="id248">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= “#pc” “[” OpCode “]”</div></blockquote>
<dl class="last docutils">
<dt>// ——————————————</dt>
<dd><p class="first">rule &lt;k&gt; #pc [ OP         ] =&gt; . … &lt;/k&gt; &lt;pc&gt; PCOUNT =&gt; PCOUNT +Int 1          &lt;/pc&gt; requires notBool (isPushOp(OP) orBool isJumpOp(OP))
rule &lt;k&gt; #pc [ PUSH(N, _) ] =&gt; . … &lt;/k&gt; &lt;pc&gt; PCOUNT =&gt; PCOUNT +Int (1 +Int N) &lt;/pc&gt;
rule &lt;k&gt; #pc [ OP         ] =&gt; . … &lt;/k&gt; requires isJumpOp(OP)</p>
<p class="last">syntax Bool ::= isJumpOp ( OpCode ) [function]</p>
</dd>
<dt>// ———————————————-</dt>
<dd>rule isJumpOp(OP) =&gt; OP ==K JUMP orBool OP ==K JUMPI</dd>
</dl>
</dd>
</dl>
<p><a href="#id249"><span class="problematic" id="id250">``</span></a><a href="#id251"><span class="problematic" id="id252">`</span></a></p>
<p>### Substate Log</p>
<p>During execution of a transaction some things are recorded in the substate log (Section 6.1 in yellowpaper).
This is a right cons-list of <cite>SubstateLogEntry</cite> (which contains the account ID along with the specified portions of the <cite>wordStack</cite> and <cite>localMem</cite>).</p>
<dl class="docutils">
<dt><a href="#id253"><span class="problematic" id="id254">``</span></a><a href="#id255"><span class="problematic" id="id256">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax SubstateLogEntry ::= “{” Int “|” WordStack “|” WordStack “}”</div></blockquote>
<p class="last">// ——————————————————————-</p>
</dd>
</dl>
<p><a href="#id257"><span class="problematic" id="id258">``</span></a><a href="#id259"><span class="problematic" id="id260">`</span></a></p>
<p>After executing a transaction, it’s necessary to have the effect of the substate log recorded.</p>
<ul class="simple">
<li><cite>#finalizeTx</cite> makes the substate log actually have an effect on the state.</li>
</ul>
<dl class="docutils">
<dt><a href="#id261"><span class="problematic" id="id262">``</span></a><a href="#id263"><span class="problematic" id="id264">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= #finalizeTx ( Bool )</div></blockquote>
<dl class="last docutils">
<dt>// ——————————————</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; #finalizeTx(true) =&gt; . … &lt;/k&gt;</dt>
<dd>&lt;selfDestruct&gt; .Set &lt;/selfDestruct&gt;</dd>
<dt>rule &lt;k&gt; #finalizeTx(false =&gt; true) … &lt;/k&gt;</dt>
<dd><p class="first">&lt;mode&gt; VMTESTS &lt;/mode&gt;
&lt;id&gt; ACCT &lt;/id&gt;
&lt;refund&gt; BAL =&gt; 0 &lt;/refund&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;balance&gt; CURRBAL =&gt; CURRBAL +Word BAL &lt;/balance&gt;
…</div></blockquote>
<p class="last">&lt;/account&gt;
&lt;activeAccounts&gt; … ACCT <a href="#id265"><span class="problematic" id="id266">|</span></a>-&gt; (EMPTY =&gt; #if BAL &gt;Int 0 #then false #else EMPTY #fi) … &lt;/activeAccounts&gt;</p>
</dd>
<dt>rule &lt;k&gt; (.K =&gt; #newAccount MINER) ~&gt; #finalizeTx(_)… &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;mode&gt; NORMAL &lt;/mode&gt;
&lt;coinbase&gt; MINER &lt;/coinbase&gt;
&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;</div></blockquote>
<p class="last">requires notBool MINER in_keys(ACCTS)</p>
</dd>
<dt>rule &lt;k&gt; #finalizeTx(false) … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div><p>&lt;mode&gt; NORMAL &lt;/mode&gt;
&lt;gas&gt; GAVAIL =&gt; G*(GAVAIL, GLIMIT, REFUND) &lt;/gas&gt;
&lt;refund&gt; REFUND =&gt; 0 &lt;/refund&gt;
&lt;txPending&gt; ListItem(MSGID:Int) … &lt;/txPending&gt;
&lt;message&gt;</p>
<blockquote>
<div>&lt;msgID&gt; MSGID &lt;/msgID&gt;
&lt;txGasLimit&gt; GLIMIT &lt;/txGasLimit&gt;
…</div></blockquote>
<p>&lt;/message&gt;</p>
</div></blockquote>
<p class="last">requires REFUND =/=Int 0</p>
</dd>
<dt>rule &lt;k&gt; #finalizeTx(false =&gt; true) … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div><p>&lt;mode&gt; NORMAL &lt;/mode&gt;
&lt;origin&gt; ORG &lt;/origin&gt;
&lt;coinbase&gt; MINER &lt;/coinbase&gt;
&lt;gas&gt; GAVAIL &lt;/gas&gt;
&lt;refund&gt; 0 &lt;/refund&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ORG &lt;/acctID&gt;
&lt;balance&gt; ORGBAL =&gt; ORGBAL +Int GAVAIL <a href="#id267"><span class="problematic" id="id268">*</span></a>Int GPRICE &lt;/balance&gt;
…</div></blockquote>
<p>&lt;/account&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; MINER &lt;/acctID&gt;
&lt;balance&gt; MINBAL =&gt; MINBAL +Int (GLIMIT -Int GAVAIL) <a href="#id269"><span class="problematic" id="id270">*</span></a>Int GPRICE &lt;/balance&gt;
…</div></blockquote>
<p>&lt;/account&gt;
&lt;txPending&gt; ListItem(TXID:Int) =&gt; .List … &lt;/txPending&gt;
&lt;message&gt;</p>
<blockquote>
<div>&lt;msgID&gt; TXID &lt;/msgID&gt;
&lt;txGasLimit&gt; GLIMIT &lt;/txGasLimit&gt;
&lt;txGasPrice&gt; GPRICE &lt;/txGasPrice&gt;
…</div></blockquote>
<p>&lt;/message&gt;
&lt;activeAccounts&gt; … ORG <a href="#id271"><span class="problematic" id="id272">|</span></a>-&gt; (ORGEMPTY =&gt; #if GAVAIL <a href="#id273"><span class="problematic" id="id274">*</span></a>Int GPRICE &gt;Int 0 #then false #else ORGEMPTY #fi) MINER <a href="#id275"><span class="problematic" id="id276">|</span></a>-&gt; (MINEMPTY =&gt; #if (GLIMIT -Int GAVAIL) <a href="#id277"><span class="problematic" id="id278">*</span></a>Int GPRICE &gt;Int 0 #then false #else MINEMPTY #fi) … &lt;/activeAccounts&gt;</p>
</div></blockquote>
<p class="last">requires ORG =/=Int MINER</p>
</dd>
<dt>rule &lt;k&gt; #finalizeTx(false =&gt; true) … &lt;/k&gt;</dt>
<dd><p class="first">&lt;mode&gt; NORMAL &lt;/mode&gt;
&lt;origin&gt; ACCT &lt;/origin&gt;
&lt;coinbase&gt; ACCT &lt;/coinbase&gt;
&lt;refund&gt; 0 &lt;/refund&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;balance&gt; BAL =&gt; BAL +Int GLIMIT <a href="#id279"><span class="problematic" id="id280">*</span></a>Int GPRICE &lt;/balance&gt;
…</div></blockquote>
<p>&lt;/account&gt;
&lt;txPending&gt; ListItem(MsgId:Int) =&gt; .List … &lt;/txPending&gt;
&lt;message&gt;</p>
<blockquote>
<div>&lt;msgID&gt; MsgId &lt;/msgID&gt;
&lt;txGasLimit&gt; GLIMIT &lt;/txGasLimit&gt;
&lt;txGasPrice&gt; GPRICE &lt;/txGasPrice&gt;
…</div></blockquote>
<p class="last">&lt;/message&gt;
&lt;activeAccounts&gt; … ACCT <a href="#id281"><span class="problematic" id="id282">|</span></a>-&gt; (EMPTY =&gt; #if GLIMIT <a href="#id283"><span class="problematic" id="id284">*</span></a>Int GPRICE &gt;Int 0 #then false #else EMPTY #fi) … &lt;/activeAccounts&gt;</p>
</dd>
<dt>rule &lt;k&gt; #finalizeTx(true) … &lt;/k&gt;</dt>
<dd><p class="first">&lt;selfDestruct&gt; … (SetItem(ACCT) =&gt; .Set) &lt;/selfDestruct&gt;
&lt;activeAccounts&gt; … (ACCT <a href="#id285"><span class="problematic" id="id286">|</span></a>-&gt; _ =&gt; .Map) &lt;/activeAccounts&gt;
&lt;accounts&gt;</p>
<blockquote>
<div><blockquote>
<div><dl class="docutils">
<dt>( &lt;account&gt;</dt>
<dd><blockquote class="first">
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
…</div></blockquote>
<p class="last">&lt;/account&gt;</p>
</dd>
</dl>
</div></blockquote>
<dl class="docutils">
<dt>=&gt; .Bag</dt>
<dd></dd>
</dl>
</div></blockquote>
<p class="last">&lt;/accounts&gt;</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id287"><span class="problematic" id="id288">``</span></a><a href="#id289"><span class="problematic" id="id290">`</span></a></p>
</div>
</div>
<div class="section" id="evm-programs">
<h1>EVM Programs<a class="headerlink" href="#evm-programs" title="Permalink to this headline">¶</a></h1>
<p>Lists of opcodes form programs.
Deciding if an opcode is in a list will be useful for modeling gas, and converting a program into a map of program-counter to opcode is useful for execution.</p>
<p>Note that <cite>_in_</cite> ignores the arguments to operators that are parametric.</p>
<dl class="docutils">
<dt><a href="#id291"><span class="problematic" id="id292">``</span></a><a href="#id293"><span class="problematic" id="id294">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax OpCodes ::= “.OpCodes” | OpCode “;” OpCodes</div></blockquote>
<p>// ————————————————–</p>
<blockquote>
<div><dl class="docutils">
<dt>syntax Map ::= #asMapOpCodes ( OpCodes )             [function]</dt>
<dd><div class="first last line-block">
<div class="line">#asMapOpCodes ( Int , OpCodes , Map ) [function, klabel(#asMapOpCodesAux)]</div>
</div>
</dd>
</dl>
</div></blockquote>
<dl class="last docutils">
<dt>// —————————————————————————————–</dt>
<dd><p class="first">rule #asMapOpCodes( OPS::OpCodes ) =&gt; #asMapOpCodes(0, OPS, .Map)</p>
<p>rule #asMapOpCodes( N , .OpCodes         , MAP ) =&gt; MAP
rule #asMapOpCodes( N , OP:OpCode  ; OCS , MAP ) =&gt; #asMapOpCodes(N +Int 1, OCS, MAP (N <a href="#id295"><span class="problematic" id="id296">|</span></a>-&gt; OP)) requires notBool isPushOp(OP)
rule #asMapOpCodes( N , PUSH(M, W) ; OCS , MAP ) =&gt; #asMapOpCodes(N +Int 1 +Int M, OCS, MAP (N <a href="#id297"><span class="problematic" id="id298">|</span></a>-&gt; PUSH(M, W)))</p>
<dl class="last docutils">
<dt>syntax OpCodes ::= #asOpCodes ( Map )                 [function]</dt>
<dd><div class="first last line-block">
<div class="line">#asOpCodes ( Int , Map , OpCodes ) [function, klabel(#asOpCodesAux)]</div>
</div>
</dd>
</dl>
</dd>
<dt>// —————————————————————————————</dt>
<dd><p class="first">rule #asOpCodes(M) =&gt; #asOpCodes(0, M, .OpCodes)</p>
<p class="last">rule #asOpCodes(N, .Map,               OPS) =&gt; OPS
rule #asOpCodes(N, N <a href="#id299"><span class="problematic" id="id300">|</span></a>-&gt; OP         M, OPS) =&gt; #asOpCodes(N +Int 1,        M, OP         ; OPS) requires notBool isPushOp(OP)
rule #asOpCodes(N, N <a href="#id301"><span class="problematic" id="id302">|</span></a>-&gt; PUSH(S, W) M, OPS) =&gt; #asOpCodes(N +Int 1 +Int S, M, PUSH(S, W) ; OPS)</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id303"><span class="problematic" id="id304">``</span></a><a href="#id305"><span class="problematic" id="id306">`</span></a></p>
<div class="section" id="evm-opcodes">
<h2>EVM OpCodes<a class="headerlink" href="#evm-opcodes" title="Permalink to this headline">¶</a></h2>
<p>Each subsection has a different class of opcodes.
Organization is based roughly on what parts of the execution state are needed to compute the result of each operator.
This sometimes corresponds to the organization in the yellowpaper.</p>
<p>### Internal Operations</p>
<p>These are just used by the other operators for shuffling local execution state around on the EVM.</p>
<ul class="simple">
<li><cite>#push</cite> will push an element to the <cite>wordStack</cite> without any checks.</li>
<li><cite>#setStack_</cite> will set the current stack to the given one.</li>
</ul>
<dl class="docutils">
<dt><a href="#id307"><span class="problematic" id="id308">``</span></a><a href="#id309"><span class="problematic" id="id310">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= “#push” | “#setStack” WordStack</div></blockquote>
<dl class="last docutils">
<dt>// —————————————————–</dt>
<dd>rule &lt;k&gt; W0:Int ~&gt; #push =&gt; . … &lt;/k&gt; &lt;wordStack&gt; WS =&gt; W0 : WS &lt;/wordStack&gt;
rule &lt;k&gt; #setStack WS    =&gt; . … &lt;/k&gt; &lt;wordStack&gt; _  =&gt; WS      &lt;/wordStack&gt;</dd>
</dl>
</dd>
</dl>
<p><a href="#id311"><span class="problematic" id="id312">``</span></a><a href="#id313"><span class="problematic" id="id314">`</span></a></p>
<ul class="simple">
<li><cite>#newAccount_</cite> allows declaring a new empty account with the given address (and assumes the rounding to 160 bits has already occured).
If the account already exists with non-zero nonce or non-empty code, an exception is thrown.
Otherwise, if the account already exists, the storage is cleared.</li>
</ul>
<dl class="docutils">
<dt><a href="#id315"><span class="problematic" id="id316">``</span></a><a href="#id317"><span class="problematic" id="id318">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= “#newAccount” Int</div></blockquote>
<dl class="last docutils">
<dt>// —————————————</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; #newAccount ACCT =&gt; #exception … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div><dl class="docutils">
<dt>&lt;account&gt;</dt>
<dd>&lt;acctID&gt; ACCT  &lt;/acctID&gt;
&lt;code&gt;   CODE  &lt;/code&gt;
&lt;nonce&gt;  NONCE &lt;/nonce&gt;
…</dd>
</dl>
<p>&lt;/account&gt;</p>
</div></blockquote>
<p class="last">requires CODE =/=K .WordStack orBool NONCE =/=K 0</p>
</dd>
<dt>rule &lt;k&gt; #newAccount ACCT =&gt; . … &lt;/k&gt;</dt>
<dd><dl class="first docutils">
<dt>&lt;account&gt;</dt>
<dd>&lt;acctID&gt;  ACCT       &lt;/acctID&gt;
&lt;code&gt;    .WordStack &lt;/code&gt;
&lt;nonce&gt;   0          &lt;/nonce&gt;
&lt;storage&gt; _ =&gt; .Map  &lt;/storage&gt;
…</dd>
</dl>
<p class="last">&lt;/account&gt;</p>
</dd>
<dt>rule &lt;k&gt; #newAccount ACCT =&gt; . … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div><p>&lt;activeAccounts&gt; ACCTS (.Map =&gt; ACCT <a href="#id319"><span class="problematic" id="id320">|</span></a>-&gt; true) &lt;/activeAccounts&gt;
&lt;accounts&gt;</p>
<blockquote>
<div><blockquote>
<div>( .Bag</div></blockquote>
<dl class="docutils">
<dt>=&gt; &lt;account&gt;</dt>
<dd><blockquote class="first last">
<div><blockquote>
<div>&lt;acctID&gt;  ACCT       &lt;/acctID&gt;
&lt;balance&gt; 0          &lt;/balance&gt;
&lt;code&gt;    .WordStack &lt;/code&gt;
&lt;storage&gt; .Map       &lt;/storage&gt;
&lt;nonce&gt;   0          &lt;/nonce&gt;</div></blockquote>
<p>&lt;/account&gt;</p>
</div></blockquote>
</dd>
</dl>
</div></blockquote>
<p>&lt;/accounts&gt;</p>
</div></blockquote>
<p class="last">requires notBool ACCT in_keys(ACCTS)</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id321"><span class="problematic" id="id322">``</span></a><a href="#id323"><span class="problematic" id="id324">`</span></a></p>
<ul class="simple">
<li><cite>#transferFunds</cite> moves money from one account into another, creating the destination account if it doesn’t exist.</li>
</ul>
<dl class="docutils">
<dt><a href="#id325"><span class="problematic" id="id326">``</span></a><a href="#id327"><span class="problematic" id="id328">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= “#transferFunds” Int Int Int</div></blockquote>
<dl class="last docutils">
<dt>// ————————————————–</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; #transferFunds ACCTFROM ACCTTO VALUE =&gt; . … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div><dl class="docutils">
<dt>&lt;account&gt;</dt>
<dd>&lt;acctID&gt; ACCTFROM &lt;/acctID&gt;
&lt;balance&gt; ORIGFROM =&gt; ORIGFROM -Word VALUE &lt;/balance&gt;
&lt;nonce&gt; NONCE &lt;/nonce&gt;
&lt;code&gt; CODE &lt;/code&gt;
…</dd>
</dl>
<p>&lt;/account&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCTTO &lt;/acctID&gt;
&lt;balance&gt; ORIGTO =&gt; ORIGTO +Word VALUE &lt;/balance&gt;
…</div></blockquote>
<p>&lt;/account&gt;
&lt;activeAccounts&gt; … ACCTTO <a href="#id329"><span class="problematic" id="id330">|</span></a>-&gt; (EMPTY =&gt; #if VALUE &gt;Int 0 #then false #else EMPTY #fi) ACCTFROM <a href="#id331"><span class="problematic" id="id332">|</span></a>-&gt; (_ =&gt; ORIGFROM ==Int VALUE andBool NONCE ==Int 0 andBool CODE ==K .WordStack) … &lt;/activeAccounts&gt;</p>
</div></blockquote>
<p class="last">requires ACCTFROM =/=K ACCTTO andBool VALUE &lt;=Int ORIGFROM</p>
</dd>
<dt>rule &lt;k&gt; #transferFunds ACCTFROM ACCTTO VALUE =&gt; #exception … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div><dl class="docutils">
<dt>&lt;account&gt;</dt>
<dd>&lt;acctID&gt; ACCTFROM &lt;/acctID&gt;
&lt;balance&gt; ORIGFROM &lt;/balance&gt;
…</dd>
</dl>
<p>&lt;/account&gt;</p>
</div></blockquote>
<p class="last">requires VALUE &gt;Int ORIGFROM</p>
</dd>
<dt>rule &lt;k&gt; (. =&gt; #newAccount ACCTTO) ~&gt; #transferFunds ACCTFROM ACCTTO VALUE … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;</div></blockquote>
<p class="last">requires ACCTFROM =/=K ACCTTO andBool notBool ACCTTO in_keys(ACCTS)</p>
</dd>
<dt>rule &lt;k&gt; #transferFunds ACCT ACCT VALUE =&gt; . … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div><dl class="docutils">
<dt>&lt;account&gt;</dt>
<dd>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;balance&gt; ORIGFROM &lt;/balance&gt;
…</dd>
</dl>
<p>&lt;/account&gt;</p>
</div></blockquote>
<p class="last">requires VALUE &lt;=Int ORIGFROM</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id333"><span class="problematic" id="id334">``</span></a><a href="#id335"><span class="problematic" id="id336">`</span></a></p>
<p>### Invalid Operator</p>
<p>We use <cite>INVALID</cite> both for marking the designated invalid operator and for garbage bytes in the input program.</p>
<dl class="docutils">
<dt><a href="#id337"><span class="problematic" id="id338">``</span></a><a href="#id339"><span class="problematic" id="id340">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InvalidOp ::= “INVALID”</div></blockquote>
<p class="last">// ——————————</p>
</dd>
</dl>
<p><a href="#id341"><span class="problematic" id="id342">``</span></a><a href="#id343"><span class="problematic" id="id344">`</span></a></p>
<p>### Stack Manipulations</p>
<p>Some operators don’t calculate anything, they just push the stack around a bit.</p>
<dl class="docutils">
<dt><a href="#id345"><span class="problematic" id="id346">``</span></a><a href="#id347"><span class="problematic" id="id348">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax UnStackOp ::= “POP”</div></blockquote>
<dl class="last docutils">
<dt>// ————————–</dt>
<dd><p class="first">rule &lt;k&gt; POP W =&gt; . … &lt;/k&gt;</p>
<p class="last">syntax StackOp ::= DUP ( Int ) | SWAP ( Int )</p>
</dd>
<dt>// ———————————————</dt>
<dd><p class="first">rule &lt;k&gt; DUP(N)  WS:WordStack =&gt; #setStack ((WS [ N -Int 1 ]) : WS)                      … &lt;/k&gt;
rule &lt;k&gt; SWAP(N) (W0 : WS)    =&gt; #setStack ((WS [ N -Int 1 ]) : (WS [ N -Int 1 := W0 ])) … &lt;/k&gt;</p>
<p class="last">syntax PushOp ::= PUSH ( Int , Int )</p>
</dd>
<dt>// ————————————</dt>
<dd>rule &lt;k&gt; PUSH(_, W) =&gt; W ~&gt; #push … &lt;/k&gt;</dd>
</dl>
</dd>
</dl>
<p><a href="#id349"><span class="problematic" id="id350">``</span></a><a href="#id351"><span class="problematic" id="id352">`</span></a></p>
<p>### Local Memory</p>
<p>These operations are getters/setters of the local execution memory.</p>
<dl class="docutils">
<dt><a href="#id353"><span class="problematic" id="id354">``</span></a><a href="#id355"><span class="problematic" id="id356">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax UnStackOp ::= “MLOAD”</div></blockquote>
<dl class="last docutils">
<dt>// —————————-</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; MLOAD INDEX =&gt; #asWord(#range(LM, INDEX, 32)) ~&gt; #push … &lt;/k&gt;</dt>
<dd>&lt;localMem&gt; LM &lt;/localMem&gt;</dd>
</dl>
<p class="last">syntax BinStackOp ::= “MSTORE” | “MSTORE8”</p>
</dd>
<dt>// ——————————————</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; MSTORE INDEX VALUE =&gt; . … &lt;/k&gt;</dt>
<dd>&lt;localMem&gt; LM =&gt; LM [ INDEX := #padToWidth(32, #asByteStack(VALUE)) ] &lt;/localMem&gt;</dd>
<dt>rule &lt;k&gt; MSTORE8 INDEX VALUE =&gt; . … &lt;/k&gt;</dt>
<dd>&lt;localMem&gt; LM =&gt; LM [ INDEX &lt;- (VALUE %Int 256) ]    &lt;/localMem&gt;</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id357"><span class="problematic" id="id358">``</span></a><a href="#id359"><span class="problematic" id="id360">`</span></a></p>
<p>### Expressions</p>
<p>Expression calculations are simple and don’t require anything but the arguments from the <cite>wordStack</cite> to operate.</p>
<p>NOTE: We have to call the opcode <cite>OR</cite> by <cite>EVMOR</cite> instead, because K has trouble parsing it/compiling the definition otherwise.</p>
<dl class="docutils">
<dt><a href="#id361"><span class="problematic" id="id362">``</span></a><a href="#id363"><span class="problematic" id="id364">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax UnStackOp ::= “ISZERO” | “NOT”</div></blockquote>
<dl class="last docutils">
<dt>// ————————————-</dt>
<dd><p class="first">rule &lt;k&gt; ISZERO 0 =&gt; 1        ~&gt; #push … &lt;/k&gt;
rule &lt;k&gt; ISZERO W =&gt; 0        ~&gt; #push … &lt;/k&gt; requires W =/=K 0
rule &lt;k&gt; NOT    W =&gt; ~Word W  ~&gt; #push … &lt;/k&gt;</p>
<p class="last">syntax BinStackOp ::= “ADD” | “MUL” | “SUB” | “DIV” | “EXP” | “MOD”</p>
</dd>
<dt>// ——————————————————————-</dt>
<dd><p class="first">rule &lt;k&gt; ADD W0 W1 =&gt; W0 +Word W1 ~&gt; #push … &lt;/k&gt;
rule &lt;k&gt; MUL W0 W1 =&gt; W0 <a href="#id365"><span class="problematic" id="id366">*</span></a>Word W1 ~&gt; #push … &lt;/k&gt;
rule &lt;k&gt; SUB W0 W1 =&gt; W0 -Word W1 ~&gt; #push … &lt;/k&gt;
rule &lt;k&gt; DIV W0 W1 =&gt; W0 /Word W1 ~&gt; #push … &lt;/k&gt;
rule &lt;k&gt; EXP W0 W1 =&gt; W0 ^Word W1 ~&gt; #push … &lt;/k&gt;
rule &lt;k&gt; MOD W0 W1 =&gt; W0 %Word W1 ~&gt; #push … &lt;/k&gt;</p>
<p class="last">syntax BinStackOp ::= “SDIV” | “SMOD”</p>
</dd>
<dt>// ————————————-</dt>
<dd><p class="first">rule &lt;k&gt; SDIV W0 W1 =&gt; W0 /sWord W1 ~&gt; #push … &lt;/k&gt;
rule &lt;k&gt; SMOD W0 W1 =&gt; W0 %sWord W1 ~&gt; #push … &lt;/k&gt;</p>
<p class="last">syntax TernStackOp ::= “ADDMOD” | “MULMOD”</p>
</dd>
<dt>// ——————————————</dt>
<dd><p class="first">rule &lt;k&gt; ADDMOD W0 W1 W2 =&gt; (W0 +Int W1) %Word W2 ~&gt; #push … &lt;/k&gt;
rule &lt;k&gt; MULMOD W0 W1 W2 =&gt; (W0 <a href="#id367"><span class="problematic" id="id368">*</span></a>Int W1) %Word W2 ~&gt; #push … &lt;/k&gt;</p>
<p class="last">syntax BinStackOp ::= “BYTE” | “SIGNEXTEND”</p>
</dd>
<dt>// ——————————————-</dt>
<dd><p class="first">rule &lt;k&gt; BYTE INDEX W     =&gt; byte(INDEX, W)     ~&gt; #push … &lt;/k&gt;
rule &lt;k&gt; SIGNEXTEND W0 W1 =&gt; signextend(W0, W1) ~&gt; #push … &lt;/k&gt;</p>
<p class="last">syntax BinStackOp ::= “AND” | “EVMOR” | “XOR”</p>
</dd>
<dt>// ———————————————</dt>
<dd><p class="first">rule &lt;k&gt; AND   W0 W1 =&gt; W0 &amp;Word W1   ~&gt; #push … &lt;/k&gt;
rule &lt;k&gt; EVMOR W0 W1 =&gt; W0 <a href="#id369"><span class="problematic" id="id370">|</span></a>Word W1   ~&gt; #push … &lt;/k&gt;
rule &lt;k&gt; XOR   W0 W1 =&gt; W0 xorWord W1 ~&gt; #push … &lt;/k&gt;</p>
<p class="last">syntax BinStackOp ::= “LT” | “GT” | “EQ”</p>
</dd>
<dt>// —————————————-</dt>
<dd><p class="first">rule &lt;k&gt; LT W0 W1 =&gt; 1 ~&gt; #push … &lt;/k&gt;  requires W0 &lt;Int   W1
rule &lt;k&gt; LT W0 W1 =&gt; 0 ~&gt; #push … &lt;/k&gt;  requires W0 &gt;=Int  W1
rule &lt;k&gt; GT W0 W1 =&gt; 1 ~&gt; #push … &lt;/k&gt;  requires W0 &gt;Int   W1
rule &lt;k&gt; GT W0 W1 =&gt; 0 ~&gt; #push … &lt;/k&gt;  requires W0 &lt;=Int  W1
rule &lt;k&gt; EQ W0 W1 =&gt; 1 ~&gt; #push … &lt;/k&gt;  requires W0 ==Int  W1
rule &lt;k&gt; EQ W0 W1 =&gt; 0 ~&gt; #push … &lt;/k&gt;  requires W0 =/=Int W1</p>
<p class="last">syntax BinStackOp ::= “SLT” | “SGT”</p>
</dd>
<dt>// ———————————–</dt>
<dd><p class="first">rule &lt;k&gt; SLT W0 W1 =&gt; W0 s&lt;Word W1 ~&gt; #push … &lt;/k&gt;
rule &lt;k&gt; SGT W0 W1 =&gt; W1 s&lt;Word W0 ~&gt; #push … &lt;/k&gt;</p>
<p class="last">syntax BinStackOp ::= “SHA3”</p>
</dd>
<dt>// —————————-</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; SHA3 MEMSTART MEMWIDTH =&gt; keccak(#range(LM, MEMSTART, MEMWIDTH)) ~&gt; #push … &lt;/k&gt;</dt>
<dd>&lt;localMem&gt; LM &lt;/localMem&gt;</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id371"><span class="problematic" id="id372">``</span></a><a href="#id373"><span class="problematic" id="id374">`</span></a></p>
<p>### Local State</p>
<p>These operators make queries about the current execution state.</p>
<dl class="docutils">
<dt><a href="#id375"><span class="problematic" id="id376">``</span></a><a href="#id377"><span class="problematic" id="id378">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax NullStackOp ::= “PC” | “GAS” | “GASPRICE” | “GASLIMIT”</div></blockquote>
<dl class="last docutils">
<dt>// ————————————————————-</dt>
<dd><p class="first">rule &lt;k&gt; PC       =&gt; PCOUNT ~&gt; #push … &lt;/k&gt; &lt;pc&gt; PCOUNT &lt;/pc&gt;
rule &lt;k&gt; GAS      =&gt; GAVAIL ~&gt; #push … &lt;/k&gt; &lt;gas&gt; GAVAIL &lt;/gas&gt;
rule &lt;k&gt; GASPRICE =&gt; GPRICE ~&gt; #push … &lt;/k&gt; &lt;gasPrice&gt; GPRICE &lt;/gasPrice&gt;
rule &lt;k&gt; GASLIMIT =&gt; GLIMIT ~&gt; #push … &lt;/k&gt; &lt;gasLimit&gt; GLIMIT &lt;/gasLimit&gt;</p>
<p class="last">syntax NullStackOp ::= “COINBASE” | “TIMESTAMP” | “NUMBER” | “DIFFICULTY”</p>
</dd>
<dt>// ————————————————————————-</dt>
<dd><p class="first">rule &lt;k&gt; COINBASE   =&gt; CB   ~&gt; #push … &lt;/k&gt; &lt;coinbase&gt; CB &lt;/coinbase&gt;
rule &lt;k&gt; TIMESTAMP  =&gt; TS   ~&gt; #push … &lt;/k&gt; &lt;timestamp&gt; TS &lt;/timestamp&gt;
rule &lt;k&gt; NUMBER     =&gt; NUMB ~&gt; #push … &lt;/k&gt; &lt;number&gt; NUMB &lt;/number&gt;
rule &lt;k&gt; DIFFICULTY =&gt; DIFF ~&gt; #push … &lt;/k&gt; &lt;difficulty&gt; DIFF &lt;/difficulty&gt;</p>
<p class="last">syntax NullStackOp ::= “ADDRESS” | “ORIGIN” | “CALLER” | “CALLVALUE”</p>
</dd>
<dt>// ——————————————————————–</dt>
<dd><p class="first">rule &lt;k&gt; ADDRESS   =&gt; ACCT ~&gt; #push … &lt;/k&gt; &lt;id&gt; ACCT &lt;/id&gt;
rule &lt;k&gt; ORIGIN    =&gt; ORG  ~&gt; #push … &lt;/k&gt; &lt;origin&gt; ORG &lt;/origin&gt;
rule &lt;k&gt; CALLER    =&gt; CL   ~&gt; #push … &lt;/k&gt; &lt;caller&gt; CL &lt;/caller&gt;
rule &lt;k&gt; CALLVALUE =&gt; CV   ~&gt; #push … &lt;/k&gt; &lt;callValue&gt; CV &lt;/callValue&gt;</p>
<p class="last">syntax NullStackOp ::= “MSIZE” | “CODESIZE”</p>
</dd>
<dt>// ——————————————-</dt>
<dd><p class="first">rule &lt;k&gt; MSIZE    =&gt; 32 <a href="#id379"><span class="problematic" id="id380">*</span></a>Word MU         ~&gt; #push … &lt;/k&gt; &lt;memoryUsed&gt; MU &lt;/memoryUsed&gt;
rule &lt;k&gt; CODESIZE =&gt; #sizeWordStack(PGM) ~&gt; #push … &lt;/k&gt; &lt;programBytes&gt; PGM &lt;/programBytes&gt;</p>
<p class="last">syntax TernStackOp ::= “CODECOPY”</p>
</dd>
<dt>// ———————————</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; CODECOPY MEMSTART PGMSTART WIDTH =&gt; . … &lt;/k&gt;</dt>
<dd>&lt;programBytes&gt; PGM &lt;/programBytes&gt;
&lt;localMem&gt; LM =&gt; LM [ MEMSTART := PGM [ PGMSTART .. WIDTH ] ] &lt;/localMem&gt;</dd>
</dl>
<p class="last">syntax UnStackOp ::= “BLOCKHASH”</p>
</dd>
<dt>// ——————————–</dt>
<dd><p class="first">rule &lt;k&gt; BLOCKHASH N =&gt; #if N &gt;=Int HI orBool HI -Int 256 &gt;Int N #then 0 #else #parseHexWord(Keccak256(Int2String(N))) #fi ~&gt; #push … &lt;/k&gt; &lt;number&gt; HI &lt;/number&gt; &lt;mode&gt; VMTESTS &lt;/mode&gt;</p>
<p>rule &lt;k&gt; BLOCKHASH N =&gt; #blockhash(HASHES, N, HI -Int 1, 0) ~&gt; #push … &lt;/k&gt; &lt;number&gt; HI &lt;/number&gt; &lt;blockhash&gt; HASHES &lt;/blockhash&gt; &lt;mode&gt; NORMAL &lt;/mode&gt;</p>
<p class="last">syntax Int ::= #blockhash ( List , Int , Int , Int ) [function]</p>
</dd>
<dt>// —————————————————————</dt>
<dd>rule #blockhash(_, N, HI, _) =&gt; 0 requires N &gt;Int HI
rule #blockhash(_, _, _, 256) =&gt; 0
rule #blockhash(ListItem(0) _, _, _, _) =&gt; 0
rule #blockhash(ListItem(H) _, N, N, _) =&gt; H
rule #blockhash(ListItem(_) L, N, HI, A) =&gt; #blockhash(L, N, HI -Int 1, A +Int 1) [owise]</dd>
</dl>
</dd>
</dl>
<p><a href="#id381"><span class="problematic" id="id382">``</span></a><a href="#id383"><span class="problematic" id="id384">`</span></a></p>
<p>### <cite>JUMP*</cite></p>
<p>The <cite>JUMP*</cite> family of operations affect the current program counter.</p>
<dl class="docutils">
<dt><a href="#id385"><span class="problematic" id="id386">``</span></a><a href="#id387"><span class="problematic" id="id388">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax NullStackOp ::= “JUMPDEST”</div></blockquote>
<dl class="last docutils">
<dt>// ———————————</dt>
<dd><p class="first">rule &lt;k&gt; JUMPDEST =&gt; . … &lt;/k&gt;</p>
<p class="last">syntax UnStackOp ::= “JUMP”</p>
</dd>
<dt>// —————————</dt>
<dd><p class="first">rule &lt;k&gt; JUMP DEST =&gt; . … &lt;/k&gt; &lt;pc&gt; _ =&gt; DEST &lt;/pc&gt;</p>
<p class="last">syntax BinStackOp ::= “JUMPI”</p>
</dd>
<dt>// —————————–</dt>
<dd>rule &lt;k&gt; JUMPI DEST I =&gt; . … &lt;/k&gt; &lt;pc&gt; _      =&gt; DEST          &lt;/pc&gt; requires I =/=K 0
rule &lt;k&gt; JUMPI DEST 0 =&gt; . … &lt;/k&gt; &lt;pc&gt; PCOUNT =&gt; PCOUNT +Int 1 &lt;/pc&gt;</dd>
</dl>
</dd>
</dl>
<p><a href="#id389"><span class="problematic" id="id390">``</span></a><a href="#id391"><span class="problematic" id="id392">`</span></a></p>
<p>### <cite>STOP</cite> and <cite>RETURN</cite></p>
<dl class="docutils">
<dt><a href="#id393"><span class="problematic" id="id394">``</span></a><a href="#id395"><span class="problematic" id="id396">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax NullStackOp ::= “STOP”</div></blockquote>
<dl class="last docutils">
<dt>// —————————–</dt>
<dd><p class="first">rule &lt;k&gt; STOP =&gt; #end … &lt;/k&gt;</p>
<p class="last">syntax BinStackOp ::= “RETURN”</p>
</dd>
<dt>// ——————————</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;mode&gt; EXECMODE &lt;/mode&gt;</dt>
<dd>&lt;k&gt; RETURN RETSTART RETWIDTH =&gt; #end … &lt;/k&gt;
&lt;output&gt; _ =&gt; #range(LM, RETSTART, RETWIDTH) &lt;/output&gt;
&lt;localMem&gt; LM &lt;/localMem&gt;</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id397"><span class="problematic" id="id398">``</span></a><a href="#id399"><span class="problematic" id="id400">`</span></a></p>
<p>### Call Data</p>
<p>These operators query about the current <cite>CALL*</cite> state.</p>
<dl class="docutils">
<dt><a href="#id401"><span class="problematic" id="id402">``</span></a><a href="#id403"><span class="problematic" id="id404">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax NullStackOp ::= “CALLDATASIZE”</div></blockquote>
<dl class="last docutils">
<dt>// ————————————-</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; CALLDATASIZE =&gt; #sizeWordStack(CD) ~&gt; #push … &lt;/k&gt;</dt>
<dd>&lt;callData&gt; CD &lt;/callData&gt;</dd>
</dl>
<p class="last">syntax UnStackOp ::= “CALLDATALOAD”</p>
</dd>
<dt>// ———————————–</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; CALLDATALOAD DATASTART =&gt; #asWord(CD [ DATASTART .. 32 ]) ~&gt; #push … &lt;/k&gt;</dt>
<dd>&lt;callData&gt; CD &lt;/callData&gt;</dd>
</dl>
<p class="last">syntax TernStackOp ::= “CALLDATACOPY”</p>
</dd>
<dt>// ————————————-</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; CALLDATACOPY MEMSTART DATASTART DATAWIDTH =&gt; . … &lt;/k&gt;</dt>
<dd>&lt;localMem&gt; LM =&gt; LM [ MEMSTART := CD [ DATASTART .. DATAWIDTH ] ] &lt;/localMem&gt;
&lt;callData&gt; CD &lt;/callData&gt;</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id405"><span class="problematic" id="id406">``</span></a><a href="#id407"><span class="problematic" id="id408">`</span></a></p>
<p>### Log Operations</p>
<dl class="docutils">
<dt><a href="#id409"><span class="problematic" id="id410">``</span></a><a href="#id411"><span class="problematic" id="id412">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax BinStackOp ::= LogOp
syntax LogOp ::= LOG ( Int )</div></blockquote>
<dl class="last docutils">
<dt>// —————————-</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; LOG(N) MEMSTART MEMWIDTH =&gt; . … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;id&gt; ACCT &lt;/id&gt;
&lt;wordStack&gt; WS =&gt; #drop(N, WS) &lt;/wordStack&gt;
&lt;localMem&gt; LM &lt;/localMem&gt;
&lt;log&gt; … (.List =&gt; ListItem({ ACCT | #take(N, WS) | #range(LM, MEMSTART, MEMWIDTH) })) &lt;/log&gt;</div></blockquote>
<p class="last">requires #sizeWordStack(WS) &gt;=Int N</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id413"><span class="problematic" id="id414">``</span></a><a href="#id415"><span class="problematic" id="id416">`</span></a></p>
</div>
<div class="section" id="ethereum-network-opcodes">
<h2>Ethereum Network OpCodes<a class="headerlink" href="#ethereum-network-opcodes" title="Permalink to this headline">¶</a></h2>
<p>Operators that require access to the rest of the Ethereum network world-state can be taken as a first draft of a “blockchain generic” language.</p>
<p>### Account Queries</p>
<p>TODO: It’s unclear what to do in the case of an account not existing for these operators.
<cite>BALANCE</cite> is specified to push 0 in this case, but the others are not specified.
For now, I assume that they instantiate an empty account and use the empty data.</p>
<dl class="docutils">
<dt><a href="#id417"><span class="problematic" id="id418">``</span></a><a href="#id419"><span class="problematic" id="id420">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax UnStackOp ::= “BALANCE”</div></blockquote>
<dl class="last docutils">
<dt>// ——————————</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; BALANCE ACCT =&gt; BAL ~&gt; #push … &lt;/k&gt;</dt>
<dd><dl class="first docutils">
<dt>&lt;account&gt;</dt>
<dd>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;balance&gt; BAL &lt;/balance&gt;
…</dd>
</dl>
<p class="last">&lt;/account&gt;</p>
</dd>
<dt>rule &lt;k&gt; BALANCE ACCT =&gt; #newAccount ACCT ~&gt; 0 ~&gt; #push … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;</div></blockquote>
<p class="last">requires notBool ACCT in_keys(ACCTS)</p>
</dd>
</dl>
<p class="last">syntax UnStackOp ::= “EXTCODESIZE”</p>
</dd>
<dt>// ———————————-</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; EXTCODESIZE ACCT =&gt; #sizeWordStack(CODE) ~&gt; #push … &lt;/k&gt;</dt>
<dd><dl class="first docutils">
<dt>&lt;account&gt;</dt>
<dd>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;code&gt; CODE &lt;/code&gt;
…</dd>
</dl>
<p class="last">&lt;/account&gt;</p>
</dd>
<dt>rule &lt;k&gt; EXTCODESIZE ACCT =&gt; #newAccount ACCT ~&gt; 0 ~&gt; #push … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;</div></blockquote>
<p class="last">requires notBool ACCT in_keys(ACCTS)</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id421"><span class="problematic" id="id422">``</span></a><a href="#id423"><span class="problematic" id="id424">`</span></a></p>
<p>TODO: What should happen in the case that the account doesn’t exist with <cite>EXTCODECOPY</cite>?
Should we pad zeros (for the copied “program”)?</p>
<dl class="docutils">
<dt><a href="#id425"><span class="problematic" id="id426">``</span></a><a href="#id427"><span class="problematic" id="id428">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax QuadStackOp ::= “EXTCODECOPY”</div></blockquote>
<dl class="last docutils">
<dt>// ————————————</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; EXTCODECOPY ACCT MEMSTART PGMSTART WIDTH =&gt; . … &lt;/k&gt;</dt>
<dd><p class="first">&lt;localMem&gt; LM =&gt; LM [ MEMSTART := PGM [ PGMSTART .. WIDTH ] ] &lt;/localMem&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;code&gt; PGM &lt;/code&gt;
…</div></blockquote>
<p class="last">&lt;/account&gt;</p>
</dd>
<dt>rule &lt;k&gt; EXTCODECOPY ACCT MEMSTART PGMSTART WIDTH =&gt; #newAccount ACCT … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;</div></blockquote>
<p class="last">requires notBool ACCT in_keys(ACCTS)</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id429"><span class="problematic" id="id430">``</span></a><a href="#id431"><span class="problematic" id="id432">`</span></a></p>
<p>### Account Storage Operations</p>
<p>These operations interact with the account storage.</p>
<dl class="docutils">
<dt><a href="#id433"><span class="problematic" id="id434">``</span></a><a href="#id435"><span class="problematic" id="id436">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax UnStackOp ::= “SLOAD”</div></blockquote>
<dl class="last docutils">
<dt>// —————————-</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; SLOAD INDEX =&gt; 0 ~&gt; #push … &lt;/k&gt;</dt>
<dd><p class="first">&lt;id&gt; ACCT &lt;/id&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;storage&gt; STORAGE &lt;/storage&gt;
…</div></blockquote>
<p class="last">&lt;/account&gt; requires notBool INDEX in_keys(STORAGE)</p>
</dd>
<dt>rule &lt;k&gt; SLOAD INDEX =&gt; VALUE ~&gt; #push … &lt;/k&gt;</dt>
<dd><p class="first">&lt;id&gt; ACCT &lt;/id&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;storage&gt; … INDEX <a href="#id437"><span class="problematic" id="id438">|</span></a>-&gt; VALUE … &lt;/storage&gt;
…</div></blockquote>
<p class="last">&lt;/account&gt;</p>
</dd>
</dl>
<p class="last">syntax BinStackOp ::= “SSTORE”</p>
</dd>
<dt>// ——————————</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; SSTORE INDEX VALUE =&gt; . … &lt;/k&gt;</dt>
<dd><p class="first">&lt;id&gt; ACCT &lt;/id&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;storage&gt; … (INDEX <a href="#id439"><span class="problematic" id="id440">|</span></a>-&gt; (OLD =&gt; VALUE)) … &lt;/storage&gt;
…</div></blockquote>
<p>&lt;/account&gt;
&lt;refund&gt; R =&gt; #ifInt OLD =/=Int 0 andBool VALUE ==Int 0</p>
<blockquote>
<div><blockquote>
<div>#then R +Word Rsstoreclear &lt; SCHED &gt;
#else R</div></blockquote>
<p>#fi</p>
</div></blockquote>
<p class="last">&lt;/refund&gt;
&lt;schedule&gt; SCHED &lt;/schedule&gt;</p>
</dd>
<dt>rule &lt;k&gt; SSTORE INDEX VALUE =&gt; . … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div><p>&lt;id&gt; ACCT &lt;/id&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;storage&gt; STORAGE =&gt; STORAGE [ INDEX &lt;- VALUE ] &lt;/storage&gt;
…</div></blockquote>
<p>&lt;/account&gt;</p>
</div></blockquote>
<p class="last">requires notBool (INDEX in_keys(STORAGE))</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id441"><span class="problematic" id="id442">``</span></a><a href="#id443"><span class="problematic" id="id444">`</span></a></p>
<p>### Call Operations</p>
<p>The various <cite>CALL*</cite> (and other inter-contract control flow) operations will be desugared into these <a href="#id445"><span class="problematic" id="id446">`</span></a>InternalOp`s.</p>
<ul class="simple">
<li>The <cite>callLog</cite> is used to store the <cite>CALL*</cite>/<cite>CREATE</cite> operations so that we can compare them against the test-set.</li>
</ul>
<dl class="docutils">
<dt><a href="#id447"><span class="problematic" id="id448">``</span></a><a href="#id449"><span class="problematic" id="id450">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Call ::= “{” Int “|” Int “|” Int “|” WordStack “}”</div></blockquote>
<p class="last">// ———————————————————</p>
</dd>
</dl>
<p><a href="#id451"><span class="problematic" id="id452">``</span></a><a href="#id453"><span class="problematic" id="id454">`</span></a></p>
<ul class="simple">
<li><cite>#call_____</cite> takes the calling account, the account to execute as, the account whose code should execute, the gas limit, the amount to transfer, and the arguments.</li>
<li><cite>#callWithCode______</cite> takes the calling account, the accout to execute as, the code to execute (as a map), the gas limit, the amount to transfer, and the arguments.</li>
<li><cite>#return__</cite> is a placeholder for the calling program, specifying where to place the returned data in memory.</li>
</ul>
<dl class="docutils">
<dt><a href="#id455"><span class="problematic" id="id456">``</span></a><a href="#id457"><span class="problematic" id="id458">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div><dl class="docutils">
<dt>syntax InternalOp ::= “#checkCall” Int Int</dt>
<dd><div class="first last line-block">
<div class="line">“#call” Int Int Int Int Int Int WordStack</div>
<div class="line">“#callWithCode” Int Int Map WordStack Int Int Int WordStack</div>
<div class="line">“#mkCall” Int Int Map WordStack Int Int Int WordStack</div>
</div>
</dd>
</dl>
</div></blockquote>
<dl class="last docutils">
<dt>// —————————————————————————</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; #checkCall ACCT VALUE ~&gt; #call _ _ _ GLIMIT _ _ _ =&gt; #refund GLIMIT ~&gt; #pushCallStack ~&gt; #pushWorldState ~&gt; #pushSubstate ~&gt; #exception … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div><blockquote>
<div><p>&lt;callDepth&gt; CD &lt;/callDepth&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;balance&gt; BAL &lt;/balance&gt;
…</div></blockquote>
<p>&lt;/account&gt;</p>
</div></blockquote>
<p>requires VALUE &gt;Int BAL orBool CD &gt;=Int 1024</p>
</div></blockquote>
<dl class="last docutils">
<dt>rule &lt;k&gt; #checkCall ACCT VALUE =&gt; . … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div><p>&lt;callDepth&gt; CD &lt;/callDepth&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;balance&gt; BAL &lt;/balance&gt;
…</div></blockquote>
<p>&lt;/account&gt;</p>
</div></blockquote>
<p class="last">requires notBool (VALUE &gt;Int BAL orBool CD &gt;=Int 1024)</p>
</dd>
</dl>
</dd>
<dt>rule &lt;k&gt; #call ACCTFROM ACCTTO ACCTCODE GLIMIT VALUE APPVALUE ARGS</dt>
<dd><blockquote class="first">
<div><blockquote>
<div>=&gt; #callWithCode ACCTFROM ACCTTO (0 <a href="#id459"><span class="problematic" id="id460">|</span></a>-&gt; #precompiled(ACCTCODE)) .WordStack GLIMIT VALUE APPVALUE ARGS</div></blockquote>
<p>…
&lt;/k&gt;</p>
</div></blockquote>
<p class="last">requires ACCTCODE &gt;Int 0 andBool ACCTCODE &lt;=Int 4</p>
</dd>
<dt>rule &lt;k&gt; #call ACCTFROM ACCTTO ACCTCODE GLIMIT VALUE APPVALUE ARGS</dt>
<dd><blockquote class="first">
<div><blockquote>
<div>=&gt; #callWithCode ACCTFROM ACCTTO #asMapOpCodes(#dasmOpCodes(CODE, SCHED)) CODE GLIMIT VALUE APPVALUE ARGS</div></blockquote>
<p>…
&lt;/k&gt;
&lt;schedule&gt; SCHED &lt;/schedule&gt;
&lt;acctID&gt; ACCTCODE &lt;/acctID&gt;
&lt;code&gt; CODE &lt;/code&gt;</p>
</div></blockquote>
<p class="last">requires notBool (ACCTCODE &gt;Int 0 andBool ACCTCODE &lt;=Int 4)</p>
</dd>
<dt>rule &lt;k&gt; #call ACCTFROM ACCTTO ACCTCODE GLIMIT VALUE APPVALUE ARGS</dt>
<dd><blockquote class="first">
<div><blockquote>
<div>=&gt; #callWithCode ACCTFROM ACCTTO .Map .WordStack GLIMIT VALUE APPVALUE ARGS</div></blockquote>
<p>…
&lt;/k&gt;
&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;</p>
</div></blockquote>
<p class="last">requires notBool (ACCTCODE &gt;Int 0 andBool ACCTCODE &lt;=Int 4) andBool notBool ACCTCODE in_keys(ACCTS)</p>
</dd>
<dt>rule #callWithCode ACCTFROM ACCTTO CODE BYTES GLIMIT VALUE APPVALUE ARGS</dt>
<dd>=&gt; #pushCallStack ~&gt; #pushWorldState ~&gt; #pushSubstate
~&gt; #transferFunds ACCTFROM ACCTTO VALUE
~&gt; #mkCall ACCTFROM ACCTTO CODE BYTES GLIMIT VALUE APPVALUE ARGS</dd>
<dt>rule &lt;mode&gt; EXECMODE &lt;/mode&gt;</dt>
<dd><dl class="first docutils">
<dt>&lt;k&gt; #mkCall ACCTFROM ACCTTO CODE BYTES GLIMIT VALUE APPVALUE ARGS</dt>
<dd>=&gt; #initVM ~&gt; #if EXECMODE ==K VMTESTS #then #end #else #execute #fi</dd>
</dl>
<p class="last">…
&lt;/k&gt;
&lt;callLog&gt; … (.Set =&gt; #ifSet EXECMODE ==K VMTESTS #then SetItem({ ACCTTO | GLIMIT | VALUE | ARGS }) #else .Set #fi) &lt;/callLog&gt;
&lt;callDepth&gt; CD =&gt; CD +Int 1 &lt;/callDepth&gt;
&lt;callData&gt; _ =&gt; ARGS &lt;/callData&gt;
&lt;callValue&gt; _ =&gt; APPVALUE &lt;/callValue&gt;
&lt;id&gt; _ =&gt; ACCTTO &lt;/id&gt;
&lt;gas&gt; _ =&gt; GLIMIT &lt;/gas&gt;
&lt;caller&gt; _ =&gt; ACCTFROM &lt;/caller&gt;
&lt;program&gt; _ =&gt; CODE &lt;/program&gt;
&lt;programBytes&gt; _ =&gt; BYTES &lt;/programBytes&gt;</p>
</dd>
</dl>
<p class="last">syntax KItem ::= “#initVM”</p>
</dd>
<dt>// ————————–</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; #initVM    =&gt; . …      &lt;/k&gt;</dt>
<dd>&lt;pc&gt;         _ =&gt; 0          &lt;/pc&gt;
&lt;memoryUsed&gt; _ =&gt; 0          &lt;/memoryUsed&gt;
&lt;output&gt;     _ =&gt; .WordStack &lt;/output&gt;
&lt;wordStack&gt;  _ =&gt; .WordStack &lt;/wordStack&gt;
&lt;localMem&gt;   _ =&gt; .Map       &lt;/localMem&gt;</dd>
</dl>
<p class="last">syntax KItem ::= “#return” Int Int</p>
</dd>
<dt>// ———————————-</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; #exception ~&gt; #return _ _</dt>
<dd><blockquote class="first">
<div>=&gt; #popCallStack ~&gt; #popWorldState ~&gt; #popSubstate ~&gt; 0 ~&gt; #push</div></blockquote>
<p class="last">…
&lt;/k&gt;</p>
</dd>
<dt>rule &lt;mode&gt; EXECMODE &lt;/mode&gt;</dt>
<dd><dl class="first docutils">
<dt>&lt;k&gt; #end ~&gt; #return RETSTART RETWIDTH</dt>
<dd>=&gt; #popCallStack
~&gt; #if EXECMODE ==K VMTESTS #then #popWorldState #else #dropWorldState #fi
~&gt; #dropSubstate
~&gt; 1 ~&gt; #push ~&gt; #refund GAVAIL ~&gt; #setLocalMem RETSTART RETWIDTH OUT</dd>
</dl>
<p class="last">…
&lt;/k&gt;
&lt;output&gt; OUT &lt;/output&gt;
&lt;gas&gt; GAVAIL &lt;/gas&gt;</p>
</dd>
<dt>syntax InternalOp ::= “#refund” Int</dt>
<dd><div class="first last line-block">
<div class="line">“#setLocalMem” Int Int WordStack</div>
</div>
</dd>
</dl>
</dd>
<dt>// ——————————————————</dt>
<dd><p class="first">rule &lt;k&gt; #refund G =&gt; . … &lt;/k&gt; &lt;gas&gt; GAVAIL =&gt; GAVAIL +Int G &lt;/gas&gt;</p>
<dl class="last docutils">
<dt>rule &lt;k&gt; #setLocalMem START WIDTH WS =&gt; . … &lt;/k&gt;</dt>
<dd>&lt;localMem&gt; LM =&gt; LM [ START := #take(minInt(WIDTH, #sizeWordStack(WS)), WS) ] &lt;/localMem&gt;</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id461"><span class="problematic" id="id462">``</span></a><a href="#id463"><span class="problematic" id="id464">`</span></a></p>
<p>For each <cite>CALL*</cite> operation, we make a corresponding call to <cite>#call</cite> and a state-change to setup the custom parts of the calling environment.</p>
<dl class="docutils">
<dt><a href="#id465"><span class="problematic" id="id466">``</span></a><a href="#id467"><span class="problematic" id="id468">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax CallOp ::= “CALL”</div></blockquote>
<dl class="last docutils">
<dt>// ————————</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; CALL GCAP ACCTTO VALUE ARGSTART ARGWIDTH RETSTART RETWIDTH</dt>
<dd><blockquote class="first">
<div>=&gt; #checkCall ACCTFROM VALUE
~&gt; #call ACCTFROM ACCTTO ACCTTO Ccallgas(SCHED, ACCTTO, ACCTS, GCAP, GAVAIL, VALUE) VALUE VALUE #range(LM, ARGSTART, ARGWIDTH)
~&gt; #return RETSTART RETWIDTH</div></blockquote>
<p class="last">…
&lt;/k&gt;
&lt;schedule&gt; SCHED &lt;/schedule&gt;
&lt;id&gt; ACCTFROM &lt;/id&gt;
&lt;localMem&gt; LM &lt;/localMem&gt;
&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;
&lt;previousGas&gt; GAVAIL &lt;/previousGas&gt;</p>
</dd>
</dl>
<p class="last">syntax CallOp ::= “CALLCODE”</p>
</dd>
<dt>// —————————-</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; CALLCODE GCAP ACCTTO VALUE ARGSTART ARGWIDTH RETSTART RETWIDTH</dt>
<dd><blockquote class="first">
<div>=&gt; #checkCall ACCTFROM VALUE
~&gt; #call ACCTFROM ACCTFROM ACCTTO Ccallgas(SCHED, ACCTFROM, ACCTS, GCAP, GAVAIL, VALUE) VALUE VALUE #range(LM, ARGSTART, ARGWIDTH)
~&gt; #return RETSTART RETWIDTH</div></blockquote>
<p class="last">…
&lt;/k&gt;
&lt;schedule&gt; SCHED &lt;/schedule&gt;
&lt;id&gt; ACCTFROM &lt;/id&gt;
&lt;localMem&gt; LM &lt;/localMem&gt;
&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;
&lt;previousGas&gt; GAVAIL &lt;/previousGas&gt;</p>
</dd>
</dl>
<p class="last">syntax CallSixOp ::= “DELEGATECALL”</p>
</dd>
<dt>// ———————————–</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; DELEGATECALL GCAP ACCTTO ARGSTART ARGWIDTH RETSTART RETWIDTH</dt>
<dd><blockquote class="first">
<div>=&gt; #checkCall ACCTFROM 0
~&gt; #call ACCTAPPFROM ACCTFROM ACCTTO Ccallgas(SCHED, ACCTFROM, ACCTS, GCAP, GAVAIL, 0) 0 VALUE #range(LM, ARGSTART, ARGWIDTH)
~&gt; #return RETSTART RETWIDTH</div></blockquote>
<p class="last">…
&lt;/k&gt;
&lt;schedule&gt; SCHED &lt;/schedule&gt;
&lt;id&gt; ACCTFROM &lt;/id&gt;
&lt;caller&gt; ACCTAPPFROM &lt;/caller&gt;
&lt;callValue&gt; VALUE &lt;/callValue&gt;
&lt;localMem&gt; LM &lt;/localMem&gt;
&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;
&lt;previousGas&gt; GAVAIL &lt;/previousGas&gt;</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id469"><span class="problematic" id="id470">``</span></a><a href="#id471"><span class="problematic" id="id472">`</span></a></p>
<p>### Account Creation/Deletion</p>
<ul class="simple">
<li><cite>#create____</cite> transfers the endowment to the new account and triggers the execution of the initialization code.</li>
<li><cite>#codeDeposit_</cite> checks the result of initialization code and whether the code deposit can be paid, indicating an error if not.</li>
</ul>
<dl class="docutils">
<dt><a href="#id473"><span class="problematic" id="id474">``</span></a><a href="#id475"><span class="problematic" id="id476">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div><dl class="docutils">
<dt>syntax InternalOp ::= “#create” Int Int Int Int WordStack</dt>
<dd><div class="first last line-block">
<div class="line">“#mkCreate” Int Int WordStack Int Int</div>
<div class="line">“#checkCreate” Int Int</div>
</div>
</dd>
</dl>
</div></blockquote>
<dl class="last docutils">
<dt>// ——————————————–</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; #checkCreate ACCT VALUE ~&gt; #create _ _ GAVAIL _ _ =&gt; #refund GAVAIL ~&gt; #pushCallStack ~&gt; #pushWorldState ~&gt; #pushSubstate ~&gt; #exception … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div><p>&lt;callDepth&gt; CD &lt;/callDepth&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;balance&gt; BAL &lt;/balance&gt;
…</div></blockquote>
<p>&lt;/account&gt;</p>
</div></blockquote>
<p class="last">requires VALUE &gt;Int BAL orBool CD &gt;=Int 1024</p>
</dd>
<dt>rule &lt;k&gt; #checkCreate ACCT VALUE =&gt; . … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div><p>&lt;mode&gt; EXECMODE &lt;/mode&gt;
&lt;callDepth&gt; CD &lt;/callDepth&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;balance&gt; BAL &lt;/balance&gt;
&lt;nonce&gt; NONCE =&gt; #ifInt EXECMODE ==K VMTESTS #then NONCE #else NONCE +Int 1 #fi &lt;/nonce&gt;
…</div></blockquote>
<p>&lt;/account&gt;
&lt;activeAccounts&gt; … ACCT <a href="#id477"><span class="problematic" id="id478">|</span></a>-&gt; (EMPTY =&gt; #if EXECMODE ==K VMTESTS #then EMPTY #else false #fi) … &lt;/activeAccounts&gt;</p>
</div></blockquote>
<p class="last">requires notBool (VALUE &gt;Int BAL orBool CD &gt;=Int 1024)</p>
</dd>
<dt>rule #create ACCTFROM ACCTTO GAVAIL VALUE INITCODE</dt>
<dd>=&gt; #pushCallStack ~&gt; #pushWorldState ~&gt; #pushSubstate
~&gt; #newAccount ACCTTO
~&gt; #transferFunds ACCTFROM ACCTTO VALUE
~&gt; #mkCreate ACCTFROM ACCTTO INITCODE GAVAIL VALUE</dd>
<dt>rule &lt;mode&gt; EXECMODE &lt;/mode&gt;</dt>
<dd><dl class="first docutils">
<dt>&lt;k&gt; #mkCreate ACCTFROM ACCTTO INITCODE GAVAIL VALUE</dt>
<dd>=&gt; #initVM ~&gt; #if EXECMODE ==K VMTESTS #then #end #else #execute #fi</dd>
</dl>
<p>…
&lt;/k&gt;
&lt;schedule&gt; SCHED &lt;/schedule&gt;
&lt;id&gt; ACCT =&gt; ACCTTO &lt;/id&gt;
&lt;gas&gt; OLDGAVAIL =&gt; GAVAIL &lt;/gas&gt;
&lt;program&gt; _ =&gt; #asMapOpCodes(#dasmOpCodes(INITCODE, SCHED)) &lt;/program&gt;
&lt;programBytes&gt; _ =&gt; INITCODE &lt;/programBytes&gt;
&lt;caller&gt; _ =&gt; ACCTFROM &lt;/caller&gt;
&lt;callLog&gt; … (.Set =&gt; #ifSet EXECMODE ==K VMTESTS #then SetItem({ 0 | OLDGAVAIL +Int GAVAIL | VALUE | INITCODE }) #else .Set #fi) &lt;/callLog&gt;
&lt;callDepth&gt; CD =&gt; CD +Int 1 &lt;/callDepth&gt;
&lt;callData&gt; _ =&gt; .WordStack &lt;/callData&gt;
&lt;callValue&gt; _ =&gt; VALUE &lt;/callValue&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCTTO &lt;/acctID&gt;
&lt;nonce&gt; NONCE =&gt; #ifInt Gemptyisnonexistent &lt;&lt; SCHED &gt;&gt; #then NONCE +Int 1 #else NONCE #fi &lt;/nonce&gt;
…</div></blockquote>
<p class="last">&lt;/account&gt;
&lt;activeAccounts&gt; … ACCTTO <a href="#id479"><span class="problematic" id="id480">|</span></a>-&gt; (EMPTY =&gt; #if Gemptyisnonexistent &lt;&lt; SCHED &gt;&gt; #then false #else EMPTY #fi) … &lt;/activeAccounts&gt;</p>
</dd>
<dt>syntax KItem ::= “#codeDeposit” Int</dt>
<dd><div class="first last line-block">
<div class="line">“#mkCodeDeposit” Int</div>
<div class="line">“#finishCodeDeposit” Int WordStack</div>
</div>
</dd>
</dl>
</dd>
<dt>// —————————————————</dt>
<dd><p class="first">rule &lt;k&gt; #exception ~&gt; #codeDeposit _ =&gt; #popCallStack ~&gt; #popWorldState ~&gt; #popSubstate ~&gt; 0 ~&gt; #push … &lt;/k&gt;</p>
<dl class="last docutils">
<dt>rule &lt;mode&gt; EXECMODE &lt;/mode&gt;</dt>
<dd>&lt;k&gt; #end ~&gt; #codeDeposit ACCT =&gt; #mkCodeDeposit ACCT … &lt;/k&gt;</dd>
<dt>rule &lt;k&gt; #mkCodeDeposit ACCT</dt>
<dd><blockquote class="first">
<div><blockquote>
<div>=&gt; #if EXECMODE ==K VMTESTS #then . #else Gcodedeposit &lt; SCHED &gt; <a href="#id481"><span class="problematic" id="id482">*</span></a>Int #sizeWordStack(OUT) ~&gt; #deductGas #fi
~&gt; #finishCodeDeposit ACCT OUT</div></blockquote>
<p>…
&lt;/k&gt;
&lt;mode&gt; EXECMODE &lt;/mode&gt;
&lt;schedule&gt; SCHED &lt;/schedule&gt;
&lt;output&gt; OUT =&gt; .WordStack &lt;/output&gt;</p>
</div></blockquote>
<p class="last">requires #sizeWordStack(OUT) &lt;=Int maxCodeSize &lt; SCHED &gt;</p>
</dd>
<dt>rule &lt;k&gt; #mkCodeDeposit ACCT =&gt; #popCallStack ~&gt; #popWorldState ~&gt; #popSubstate ~&gt; 0 ~&gt; #push … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;schedule&gt; SCHED &lt;/schedule&gt;
&lt;output&gt; OUT =&gt; .WordStack &lt;/output&gt;</div></blockquote>
<p class="last">requires #sizeWordStack(OUT) &gt;Int maxCodeSize &lt; SCHED &gt;</p>
</dd>
<dt>rule &lt;k&gt; #finishCodeDeposit ACCT OUT</dt>
<dd><blockquote class="first">
<div>=&gt; #popCallStack ~&gt; #if EXECMODE ==K VMTESTS #then #popWorldState #else #dropWorldState #fi ~&gt; #dropSubstate
~&gt; #refund GAVAIL ~&gt; ACCT ~&gt; #push</div></blockquote>
<p>…
&lt;/k&gt;
&lt;mode&gt; EXECMODE &lt;/mode&gt;
&lt;gas&gt; GAVAIL &lt;/gas&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;code&gt; _ =&gt; OUT &lt;/code&gt;
…</div></blockquote>
<p class="last">&lt;/account&gt;
&lt;activeAccounts&gt; … ACCT <a href="#id483"><span class="problematic" id="id484">|</span></a>-&gt; (EMPTY =&gt; #if OUT =/=K .WordStack #then false #else EMPTY #fi) … &lt;/activeAccounts&gt;</p>
</dd>
<dt>rule &lt;k&gt; #exception ~&gt; #finishCodeDeposit ACCT _</dt>
<dd><blockquote class="first">
<div>=&gt; #popCallStack ~&gt; #if EXECMODE ==K VMTESTS #then #popWorldState #else #dropWorldState #fi ~&gt; #dropSubstate
~&gt; #refund GAVAIL ~&gt; ACCT ~&gt; #push</div></blockquote>
<p class="last">…
&lt;/k&gt;
&lt;mode&gt; EXECMODE &lt;/mode&gt;
&lt;gas&gt; GAVAIL &lt;/gas&gt;
&lt;schedule&gt; FRONTIER &lt;/schedule&gt;</p>
</dd>
<dt>rule &lt;k&gt; #exception ~&gt; #finishCodeDeposit _ _ =&gt; #popCallStack ~&gt; #popWorldState ~&gt; #popSubstate ~&gt; 0 ~&gt; #push … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div>&lt;schedule&gt; SCHED &lt;/schedule&gt;</div></blockquote>
<p class="last">requires SCHED =/=K FRONTIER</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id485"><span class="problematic" id="id486">``</span></a><a href="#id487"><span class="problematic" id="id488">`</span></a></p>
<p><cite>CREATE</cite> will attempt to <cite>#create</cite> the account using the initialization code and cleans up the result with <cite>#codeDeposit</cite>.</p>
<dl class="docutils">
<dt><a href="#id489"><span class="problematic" id="id490">``</span></a><a href="#id491"><span class="problematic" id="id492">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax TernStackOp ::= “CREATE”</div></blockquote>
<dl class="last docutils">
<dt>// ——————————-</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; CREATE VALUE MEMSTART MEMWIDTH</dt>
<dd><blockquote class="first">
<div>=&gt; #checkCreate ACCT VALUE
~&gt; #create ACCT #newAddr(ACCT, NONCE) #ifInt Gstaticcalldepth &lt;&lt; SCHED &gt;&gt; #then GAVAIL #else #allBut64th(GAVAIL) #fi VALUE #range(LM, MEMSTART, MEMWIDTH)
~&gt; #codeDeposit #newAddr(ACCT, NONCE)</div></blockquote>
<p>…
&lt;/k&gt;
&lt;schedule&gt; SCHED &lt;/schedule&gt;
&lt;id&gt; ACCT &lt;/id&gt;
&lt;gas&gt; GAVAIL =&gt; #ifInt Gstaticcalldepth &lt;&lt; SCHED &gt;&gt; #then 0 #else GAVAIL /Int 64 #fi &lt;/gas&gt;
&lt;localMem&gt; LM &lt;/localMem&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;nonce&gt; NONCE &lt;/nonce&gt;
…</div></blockquote>
<p class="last">&lt;/account&gt;</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id493"><span class="problematic" id="id494">``</span></a><a href="#id495"><span class="problematic" id="id496">`</span></a></p>
<p><cite>SELFDESTRUCT</cite> marks the current account for deletion and transfers funds out of the current account.
Self destructing to yourself, unlike a regular transfer, destroys the balance in the account, irreparably losing it.</p>
<dl class="docutils">
<dt><a href="#id497"><span class="problematic" id="id498">``</span></a><a href="#id499"><span class="problematic" id="id500">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax UnStackOp ::= “SELFDESTRUCT”</div></blockquote>
<dl class="last docutils">
<dt>// ———————————–</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; SELFDESTRUCT ACCTTO =&gt; #transferFunds ACCT ACCTTO BALFROM ~&gt; #end … &lt;/k&gt;</dt>
<dd><blockquote class="first">
<div><p>&lt;schedule&gt; SCHED &lt;/schedule&gt;
&lt;id&gt; ACCT &lt;/id&gt;
&lt;selfDestruct&gt; SDS (.Set =&gt; SetItem(ACCT)) &lt;/selfDestruct&gt;
&lt;refund&gt; RF =&gt; #ifInt ACCT in SDS #then RF #else RF +Word Rselfdestruct &lt; SCHED &gt; #fi &lt;/refund&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;balance&gt; BALFROM &lt;/balance&gt;
…</div></blockquote>
<p>&lt;/account&gt;</p>
</div></blockquote>
<p class="last">requires ACCT =/=Int ACCTTO</p>
</dd>
<dt>rule &lt;k&gt; SELFDESTRUCT ACCT =&gt; #end … &lt;/k&gt;</dt>
<dd><p class="first">&lt;schedule&gt; SCHED &lt;/schedule&gt;
&lt;id&gt; ACCT &lt;/id&gt;
&lt;selfDestruct&gt; SDS (.Set =&gt; SetItem(ACCT)) &lt;/selfDestruct&gt;
&lt;refund&gt; RF =&gt; #ifInt ACCT in SDS #then RF #else RF +Word Rselfdestruct &lt; SCHED &gt; #fi &lt;/refund&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;balance&gt; BALFROM =&gt; 0 &lt;/balance&gt;
&lt;nonce&gt; NONCE &lt;/nonce&gt;
&lt;code&gt; CODE &lt;/code&gt;
…</div></blockquote>
<p class="last">&lt;/account&gt;
&lt;activeAccounts&gt; … ACCT <a href="#id501"><span class="problematic" id="id502">|</span></a>-&gt; (_ =&gt; NONCE ==Int 0 andBool CODE ==K .WordStack) … &lt;/activeAccounts&gt;</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id503"><span class="problematic" id="id504">``</span></a><a href="#id505"><span class="problematic" id="id506">`</span></a></p>
</div>
</div>
<div class="section" id="precompiled-contracts">
<h1>Precompiled Contracts<a class="headerlink" href="#precompiled-contracts" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><cite>#precompiled</cite> is a placeholder for the 4 pre-compiled contracts at addresses 1 through 4.</li>
</ul>
<dl class="docutils">
<dt><a href="#id507"><span class="problematic" id="id508">``</span></a><a href="#id509"><span class="problematic" id="id510">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax NullStackOp   ::= PrecompiledOp
syntax PrecompiledOp ::= #precompiled ( Int ) [function]</div></blockquote>
<dl class="last docutils">
<dt>// ——————————————————–</dt>
<dd>rule #precompiled(1) =&gt; ECREC
rule #precompiled(2) =&gt; SHA256
rule #precompiled(3) =&gt; RIP160
rule #precompiled(4) =&gt; ID</dd>
</dl>
</dd>
</dl>
<p><a href="#id511"><span class="problematic" id="id512">``</span></a><a href="#id513"><span class="problematic" id="id514">`</span></a></p>
<ul class="simple">
<li><cite>ECREC</cite> performs ECDSA public key recovery.</li>
<li><cite>SHA256</cite> performs the SHA2-257 hash function.</li>
<li><cite>RIP160</cite> performs the RIPEMD-160 hash function.</li>
<li><cite>ID</cite> is the identity function (copies input to output).</li>
</ul>
<dl class="docutils">
<dt><a href="#id515"><span class="problematic" id="id516">``</span></a><a href="#id517"><span class="problematic" id="id518">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax PrecompiledOp ::= “ECREC”</div></blockquote>
<dl class="last docutils">
<dt>// ——————————–</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; ECREC =&gt; #end … &lt;/k&gt;</dt>
<dd>&lt;callData&gt; DATA &lt;/callData&gt;
&lt;output&gt; _ =&gt; #ecrec(#sender(#unparseByteStack(DATA [ 0 .. 32 ]), #asWord(DATA [ 32 .. 32 ]), #unparseByteStack(DATA [ 64 .. 32 ]), #unparseByteStack(DATA [ 96 .. 32 ]))) &lt;/output&gt;</dd>
</dl>
<p class="last">syntax WordStack ::= #ecrec ( Account ) [function]</p>
</dd>
<dt>// ————————————————–</dt>
<dd><p class="first">rule #ecrec(.Account) =&gt; .WordStack
rule #ecrec(N:Int)    =&gt; #padToWidth(32, #asByteStack(N))</p>
<p class="last">syntax PrecompiledOp ::= “SHA256”</p>
</dd>
<dt>// ———————————</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; SHA256 =&gt; #end … &lt;/k&gt;</dt>
<dd>&lt;callData&gt; DATA &lt;/callData&gt;
&lt;output&gt; _ =&gt; #parseHexBytes(Sha256(#unparseByteStack(DATA))) &lt;/output&gt;</dd>
</dl>
<p class="last">syntax PrecompiledOp ::= “RIP160”</p>
</dd>
<dt>// ———————————</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; RIP160 =&gt; #end … &lt;/k&gt;</dt>
<dd>&lt;callData&gt; DATA &lt;/callData&gt;
&lt;output&gt; _ =&gt; #padToWidth(32, #parseHexBytes(RipEmd160(#unparseByteStack(DATA)))) &lt;/output&gt;</dd>
</dl>
<p class="last">syntax PrecompiledOp ::= “ID”</p>
</dd>
<dt>// —————————–</dt>
<dd><dl class="first last docutils">
<dt>rule &lt;k&gt; ID =&gt; #end … &lt;/k&gt;</dt>
<dd>&lt;callData&gt; DATA &lt;/callData&gt;
&lt;output&gt; _ =&gt; DATA &lt;/output&gt;</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id519"><span class="problematic" id="id520">``</span></a><a href="#id521"><span class="problematic" id="id522">`</span></a></p>
</div>
<div class="section" id="ethereum-gas-calculation">
<h1>Ethereum Gas Calculation<a class="headerlink" href="#ethereum-gas-calculation" title="Permalink to this headline">¶</a></h1>
<p>The gas calculation is designed to mirror the style of the yellowpaper.
Gas is consumed either by increasing the amount of memory being used, or by executing opcodes.</p>
<div class="section" id="memory-consumption">
<h2>Memory Consumption<a class="headerlink" href="#memory-consumption" title="Permalink to this headline">¶</a></h2>
<p>Memory consumed is tracked to determine the appropriate amount of gas to charge for each operation.
In the yellowpaper, each opcode is defined to consume zero gas unless specified otherwise next to the semantics of the opcode (appendix H).</p>
<ul class="simple">
<li><cite>#memory</cite> computes the new memory size given the old size and next operator (with its arguments).</li>
<li><cite>#memoryUsageUpdate</cite> is the function <cite>M</cite> in appendix H of the yellowpaper which helps track the memory used.</li>
</ul>
<dl class="docutils">
<dt><a href="#id523"><span class="problematic" id="id524">``</span></a><a href="#id525"><span class="problematic" id="id526">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Int ::= #memory ( OpCode , Int ) [function]</div></blockquote>
<dl class="last docutils">
<dt>// ————————————————–</dt>
<dd><p class="first">rule #memory ( MLOAD INDEX     , MU ) =&gt; #memoryUsageUpdate(MU, INDEX, 32)
rule #memory ( MSTORE INDEX _  , MU ) =&gt; #memoryUsageUpdate(MU, INDEX, 32)
rule #memory ( MSTORE8 INDEX _ , MU ) =&gt; #memoryUsageUpdate(MU, INDEX, 1)</p>
<p>rule #memory ( SHA3 START WIDTH   , MU ) =&gt; #memoryUsageUpdate(MU, START, WIDTH)
rule #memory ( LOG(_) START WIDTH , MU ) =&gt; #memoryUsageUpdate(MU, START, WIDTH)</p>
<p>rule #memory ( CODECOPY START _ WIDTH      , MU ) =&gt; #memoryUsageUpdate(MU, START, WIDTH)
rule #memory ( EXTCODECOPY _ START _ WIDTH , MU ) =&gt; #memoryUsageUpdate(MU, START, WIDTH)
rule #memory ( CALLDATACOPY START _ WIDTH  , MU ) =&gt; #memoryUsageUpdate(MU, START, WIDTH)</p>
<p>rule #memory ( CREATE _ START WIDTH , MU ) =&gt; #memoryUsageUpdate(MU, START, WIDTH)
rule #memory ( RETURN START WIDTH   , MU ) =&gt; #memoryUsageUpdate(MU, START, WIDTH)</p>
<p class="last">rule #memory ( COP:CallOp     _ _ _ ARGSTART ARGWIDTH RETSTART RETWIDTH , MU ) =&gt; #memoryUsageUpdate(#memoryUsageUpdate(MU, ARGSTART, ARGWIDTH), RETSTART, RETWIDTH)
rule #memory ( CSOP:CallSixOp _ _   ARGSTART ARGWIDTH RETSTART RETWIDTH , MU ) =&gt; #memoryUsageUpdate(#memoryUsageUpdate(MU, ARGSTART, ARGWIDTH), RETSTART, RETWIDTH)</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id527"><span class="problematic" id="id528">``</span></a><a href="#id529"><span class="problematic" id="id530">`</span></a></p>
<p>Grumble grumble, K sucks at <cite>owise</cite>.</p>
<dl class="docutils">
<dt><a href="#id531"><span class="problematic" id="id532">``</span></a><a href="#id533"><span class="problematic" id="id534">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div><p>rule #memory(JUMP _,    MU) =&gt; MU
rule #memory(JUMPI _ _, MU) =&gt; MU
rule #memory(JUMPDEST,  MU) =&gt; MU</p>
<p>rule #memory(SSTORE _ _,   MU) =&gt; MU
rule #memory(SLOAD _,      MU) =&gt; MU</p>
<p>rule #memory(ADD _ _,        MU) =&gt; MU
rule #memory(SUB _ _,        MU) =&gt; MU
rule #memory(MUL _ _,        MU) =&gt; MU
rule #memory(DIV _ _,        MU) =&gt; MU
rule #memory(EXP _ _,        MU) =&gt; MU
rule #memory(MOD _ _,        MU) =&gt; MU
rule #memory(SDIV _ _,       MU) =&gt; MU
rule #memory(SMOD _ _,       MU) =&gt; MU
rule #memory(SIGNEXTEND _ _, MU) =&gt; MU
rule #memory(ADDMOD _ _ _,   MU) =&gt; MU
rule #memory(MULMOD _ _ _,   MU) =&gt; MU</p>
<p>rule #memory(NOT _,     MU) =&gt; MU
rule #memory(AND _ _,   MU) =&gt; MU
rule #memory(EVMOR _ _, MU) =&gt; MU
rule #memory(XOR _ _,   MU) =&gt; MU
rule #memory(BYTE _ _,  MU) =&gt; MU
rule #memory(ISZERO _,  MU) =&gt; MU</p>
<p>rule #memory(LT _ _,         MU) =&gt; MU
rule #memory(GT _ _,         MU) =&gt; MU
rule #memory(SLT _ _,        MU) =&gt; MU
rule #memory(SGT _ _,        MU) =&gt; MU
rule #memory(EQ _ _,         MU) =&gt; MU</p>
<p>rule #memory(POP _,      MU) =&gt; MU
rule #memory(PUSH(_, _), MU) =&gt; MU
rule #memory(DUP(_) _,   MU) =&gt; MU
rule #memory(SWAP(_) _,  MU) =&gt; MU</p>
<p>rule #memory(STOP,         MU) =&gt; MU
rule #memory(ADDRESS,      MU) =&gt; MU
rule #memory(ORIGIN,       MU) =&gt; MU
rule #memory(CALLER,       MU) =&gt; MU
rule #memory(CALLVALUE,    MU) =&gt; MU
rule #memory(CALLDATASIZE, MU) =&gt; MU
rule #memory(CODESIZE,     MU) =&gt; MU
rule #memory(GASPRICE,     MU) =&gt; MU
rule #memory(COINBASE,     MU) =&gt; MU
rule #memory(TIMESTAMP,    MU) =&gt; MU
rule #memory(NUMBER,       MU) =&gt; MU
rule #memory(DIFFICULTY,   MU) =&gt; MU
rule #memory(GASLIMIT,     MU) =&gt; MU
rule #memory(PC,           MU) =&gt; MU
rule #memory(MSIZE,        MU) =&gt; MU
rule #memory(GAS,          MU) =&gt; MU</p>
<p>rule #memory(SELFDESTRUCT _, MU) =&gt; MU
rule #memory(CALLDATALOAD _, MU) =&gt; MU
rule #memory(EXTCODESIZE _,  MU) =&gt; MU
rule #memory(BALANCE _,      MU) =&gt; MU
rule #memory(BLOCKHASH _,    MU) =&gt; MU</p>
<p>rule #memory(_:PrecompiledOp, MU) =&gt; MU</p>
<p>syntax Int ::= #memoryUsageUpdate ( Int , Int , Int ) [function]</p>
</div></blockquote>
<dl class="last docutils">
<dt>// —————————————————————-</dt>
<dd>rule #memoryUsageUpdate(MU, START, 0)     =&gt; MU
rule #memoryUsageUpdate(MU, START, WIDTH) =&gt; maxInt(MU, (START +Int WIDTH) up/Int 32) requires WIDTH &gt;Int 0</dd>
</dl>
</dd>
</dl>
<p><a href="#id535"><span class="problematic" id="id536">``</span></a><a href="#id537"><span class="problematic" id="id538">`</span></a></p>
</div>
<div class="section" id="execution-gas">
<h2>Execution Gas<a class="headerlink" href="#execution-gas" title="Permalink to this headline">¶</a></h2>
<p>Each opcode has an intrinsic gas cost of execution as well (appendix H of the yellowpaper).</p>
<ul class="simple">
<li><cite>#gasExec</cite> loads all the relevant surronding state and uses that to compute the intrinsic execution gas of each opcode.</li>
</ul>
<dl class="docutils">
<dt><a href="#id539"><span class="problematic" id="id540">``</span></a><a href="#id541"><span class="problematic" id="id542">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax InternalOp ::= #gasExec ( Schedule , OpCode )</div></blockquote>
<dl class="last docutils">
<dt>// —————————————————-</dt>
<dd><dl class="first docutils">
<dt>rule &lt;k&gt; #gasExec(SCHED, SSTORE INDEX VALUE) =&gt; Csstore(SCHED, VALUE, #lookup(STORAGE, INDEX)) … &lt;/k&gt;</dt>
<dd><p class="first">&lt;id&gt; ACCT &lt;/id&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCT &lt;/acctID&gt;
&lt;storage&gt; STORAGE &lt;/storage&gt;
…</div></blockquote>
<p class="last">&lt;/account&gt;</p>
</dd>
</dl>
<p>rule &lt;k&gt; #gasExec(SCHED, EXP W0 0)  =&gt; Gexp &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, EXP W0 W1) =&gt; Gexp &lt; SCHED &gt; +Int (Gexpbyte &lt; SCHED &gt; <a href="#id543"><span class="problematic" id="id544">*</span></a>Int (1 +Int (log256Int(W1)))) … &lt;/k&gt; requires W1 =/=K 0</p>
<p>rule &lt;k&gt; #gasExec(SCHED, CALLDATACOPY  _ _ WIDTH) =&gt; Gverylow     &lt; SCHED &gt; +Int (Gcopy &lt; SCHED &gt; <a href="#id545"><span class="problematic" id="id546">*</span></a>Int (WIDTH up/Int 32)) … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, CODECOPY      _ _ WIDTH) =&gt; Gverylow     &lt; SCHED &gt; +Int (Gcopy &lt; SCHED &gt; <a href="#id547"><span class="problematic" id="id548">*</span></a>Int (WIDTH up/Int 32)) … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, EXTCODECOPY _ _ _ WIDTH) =&gt; Gextcodecopy &lt; SCHED &gt; +Int (Gcopy &lt; SCHED &gt; <a href="#id549"><span class="problematic" id="id550">*</span></a>Int (WIDTH up/Int 32)) … &lt;/k&gt;</p>
<p>rule &lt;k&gt; #gasExec(SCHED, LOG(N) _ WIDTH) =&gt; (Glog &lt; SCHED &gt; +Int (Glogdata &lt; SCHED &gt; <a href="#id551"><span class="problematic" id="id552">*</span></a>Int WIDTH) +Int (N <a href="#id553"><span class="problematic" id="id554">*</span></a>Int Glogtopic &lt; SCHED &gt;)) … &lt;/k&gt;</p>
<dl class="docutils">
<dt>rule &lt;k&gt; #gasExec(SCHED, CALL         GCAP ACCTTO VALUE _ _ _ _) =&gt; Ccall(SCHED, ACCTTO,   ACCTS, GCAP, GAVAIL, VALUE) … &lt;/k&gt;</dt>
<dd>&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;
&lt;gas&gt; GAVAIL &lt;/gas&gt;</dd>
<dt>rule &lt;k&gt; #gasExec(SCHED, CALLCODE     GCAP _      VALUE _ _ _ _) =&gt; Ccall(SCHED, ACCTFROM, ACCTS, GCAP, GAVAIL, VALUE) … &lt;/k&gt;</dt>
<dd>&lt;id&gt; ACCTFROM &lt;/id&gt;
&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;
&lt;gas&gt; GAVAIL &lt;/gas&gt;</dd>
<dt>rule &lt;k&gt; #gasExec(SCHED, DELEGATECALL GCAP _ _ _ _ _) =&gt; Ccall(SCHED, ACCTFROM, ACCTS, GCAP, GAVAIL, 0) … &lt;/k&gt;</dt>
<dd>&lt;id&gt; ACCTFROM &lt;/id&gt;
&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;
&lt;gas&gt; GAVAIL &lt;/gas&gt;</dd>
<dt>rule &lt;k&gt; #gasExec(SCHED, SELFDESTRUCT ACCTTO) =&gt; Cselfdestruct(SCHED, ACCTTO, ACCTS, BAL) … &lt;/k&gt;</dt>
<dd><p class="first">&lt;activeAccounts&gt; ACCTS &lt;/activeAccounts&gt;
&lt;id&gt; ACCTFROM &lt;/id&gt;
&lt;account&gt;</p>
<blockquote>
<div>&lt;acctID&gt; ACCTFROM &lt;/acctID&gt;
&lt;balance&gt; BAL &lt;/balance&gt;
…</div></blockquote>
<p class="last">&lt;/account&gt;</p>
</dd>
</dl>
<p>rule &lt;k&gt; #gasExec(SCHED, CREATE _ _ _) =&gt; Gcreate &lt; SCHED &gt; … &lt;/k&gt;</p>
<p>rule &lt;k&gt; #gasExec(SCHED, SHA3 _ WIDTH) =&gt; Gsha3 &lt; SCHED &gt; +Int (Gsha3word &lt; SCHED &gt; <a href="#id555"><span class="problematic" id="id556">*</span></a>Int (WIDTH up/Int 32)) … &lt;/k&gt;</p>
<p>rule &lt;k&gt; #gasExec(SCHED, JUMPDEST) =&gt; Gjumpdest &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, SLOAD _)  =&gt; Gsload    &lt; SCHED &gt; … &lt;/k&gt;</p>
<p>// Wzero
rule &lt;k&gt; #gasExec(SCHED, STOP)       =&gt; Gzero &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, RETURN _ _) =&gt; Gzero &lt; SCHED &gt; … &lt;/k&gt;</p>
<p>// Wbase
rule &lt;k&gt; #gasExec(SCHED, ADDRESS)      =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, ORIGIN)       =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, CALLER)       =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, CALLVALUE)    =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, CALLDATASIZE) =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, CODESIZE)     =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, GASPRICE)     =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, COINBASE)     =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, TIMESTAMP)    =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, NUMBER)       =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, DIFFICULTY)   =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, GASLIMIT)     =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, POP _)        =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, PC)           =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, MSIZE)        =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, GAS)          =&gt; Gbase &lt; SCHED &gt; … &lt;/k&gt;</p>
<p>// Wverylow
rule &lt;k&gt; #gasExec(SCHED, ADD _ _)        =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, SUB _ _)        =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, NOT _)          =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, LT _ _)         =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, GT _ _)         =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, SLT _ _)        =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, SGT _ _)        =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, EQ _ _)         =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, ISZERO _)       =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, AND _ _)        =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, EVMOR _ _)      =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, XOR _ _)        =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, BYTE _ _)       =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, CALLDATALOAD _) =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, MLOAD _)        =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, MSTORE _ _)     =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, MSTORE8 _ _)    =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, PUSH(_, _))     =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, DUP(_) _)       =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, SWAP(_) _)      =&gt; Gverylow &lt; SCHED &gt; … &lt;/k&gt;</p>
<p>// Wlow
rule &lt;k&gt; #gasExec(SCHED, MUL _ _)        =&gt; Glow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, DIV _ _)        =&gt; Glow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, SDIV _ _)       =&gt; Glow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, MOD _ _)        =&gt; Glow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, SMOD _ _)       =&gt; Glow &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, SIGNEXTEND _ _) =&gt; Glow &lt; SCHED &gt; … &lt;/k&gt;</p>
<p>// Wmid
rule &lt;k&gt; #gasExec(SCHED, ADDMOD _ _ _) =&gt; Gmid &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, MULMOD _ _ _) =&gt; Gmid &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, JUMP _) =&gt; Gmid &lt; SCHED &gt; … &lt;/k&gt;</p>
<p>// Whigh
rule &lt;k&gt; #gasExec(SCHED, JUMPI _ _) =&gt; Ghigh &lt; SCHED &gt; … &lt;/k&gt;</p>
<p>rule &lt;k&gt; #gasExec(SCHED, EXTCODESIZE _) =&gt; Gextcodesize &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, BALANCE _)     =&gt; Gbalance     &lt; SCHED &gt; … &lt;/k&gt;
rule &lt;k&gt; #gasExec(SCHED, BLOCKHASH _)   =&gt; Gblockhash   &lt; SCHED &gt; … &lt;/k&gt;</p>
<p class="last">// Precompiled
rule &lt;k&gt; #gasExec(_, ECREC)  =&gt; 3000 … &lt;/k&gt;
rule &lt;k&gt; #gasExec(_, SHA256) =&gt;  60 +Int  12 <a href="#id557"><span class="problematic" id="id558">*</span></a>Int (#sizeWordStack(DATA) up/Int 32) … &lt;/k&gt; &lt;callData&gt; DATA &lt;/callData&gt;
rule &lt;k&gt; #gasExec(_, RIP160) =&gt; 600 +Int 120 <a href="#id559"><span class="problematic" id="id560">*</span></a>Int (#sizeWordStack(DATA) up/Int 32) … &lt;/k&gt; &lt;callData&gt; DATA &lt;/callData&gt;
rule &lt;k&gt; #gasExec(_, ID)     =&gt;  15 +Int   3 <a href="#id561"><span class="problematic" id="id562">*</span></a>Int (#sizeWordStack(DATA) up/Int 32) … &lt;/k&gt; &lt;callData&gt; DATA &lt;/callData&gt;</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id563"><span class="problematic" id="id564">``</span></a><a href="#id565"><span class="problematic" id="id566">`</span></a></p>
<p>There are several helpers for calculating gas (most of them also specified in the yellowpaper).</p>
<p>Note: These are all functions as the operator <cite>#gasExec</cite> has already loaded all the relevant state.</p>
<dl class="docutils">
<dt><a href="#id567"><span class="problematic" id="id568">``</span></a><a href="#id569"><span class="problematic" id="id570">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Int ::= Csstore ( Schedule , Int , Int ) [function]</div></blockquote>
<dl class="last docutils">
<dt>// ———————————————————-</dt>
<dd><p class="first">rule Csstore(SCHED, VALUE, OLD) =&gt; #ifInt VALUE =/=Int 0 andBool OLD ==Int 0 #then Gsstoreset &lt; SCHED &gt; #else Gsstorereset &lt; SCHED &gt; #fi</p>
<dl class="last docutils">
<dt>syntax Int ::= Ccall    ( Schedule , Int , Map , Int , Int , Int ) [function]</dt>
<dd><div class="first last line-block">
<div class="line">Ccallgas ( Schedule , Int , Map , Int , Int , Int ) [function]</div>
<div class="line">Cgascap  ( Schedule , Int , Int , Int )             [function]</div>
<div class="line">Cextra   ( Schedule , Int , Map , Int )             [function]</div>
<div class="line">Cxfer    ( Schedule , Int )                         [function]</div>
<div class="line">Cnew     ( Schedule , Int , Map , Int )             [function]</div>
</div>
</dd>
</dl>
</dd>
<dt>// —————————————————————————–</dt>
<dd><p class="first">rule Ccall(SCHED, ACCT, ACCTS, GCAP, GAVAIL, VALUE) =&gt; Cextra(SCHED, ACCT, ACCTS, VALUE) +Int Cgascap(SCHED, GCAP, GAVAIL, Cextra(SCHED, ACCT, ACCTS, VALUE))</p>
<p>rule Ccallgas(SCHED, ACCT, ACCTS, GCAP, GAVAIL, 0)     =&gt; Cgascap(SCHED, GCAP, GAVAIL, Cextra(SCHED, ACCT, ACCTS,     0))
rule Ccallgas(SCHED, ACCT, ACCTS, GCAP, GAVAIL, VALUE) =&gt; Cgascap(SCHED, GCAP, GAVAIL, Cextra(SCHED, ACCT, ACCTS, VALUE)) +Int Gcallstipend &lt; SCHED &gt; requires VALUE =/=K 0</p>
<p>rule Cgascap(SCHED, GCAP, GAVAIL, GEXTRA) =&gt; minInt(#allBut64th(GAVAIL -Int GEXTRA), GCAP) requires GAVAIL &gt;=Int GEXTRA andBool notBool Gstaticcalldepth &lt;&lt; SCHED &gt;&gt;
rule Cgascap(SCHED, GCAP, GAVAIL, GEXTRA) =&gt; GCAP                                          requires GAVAIL &lt;Int  GEXTRA orBool Gstaticcalldepth &lt;&lt; SCHED &gt;&gt;</p>
<p>rule Cextra(SCHED, ACCT, ACCTS, VALUE) =&gt; Gcall &lt; SCHED &gt; +Int Cnew(SCHED, ACCT, ACCTS, VALUE) +Int Cxfer(SCHED, VALUE)</p>
<p>rule Cxfer(SCHED, 0) =&gt; 0
rule Cxfer(SCHED, N) =&gt; Gcallvalue &lt; SCHED &gt; requires N =/=K 0</p>
<dl class="docutils">
<dt>rule Cnew(SCHED, ACCT, ACCTS, VALUE) =&gt; Gnewaccount &lt; SCHED &gt;</dt>
<dd>requires         #accountNonexistent(SCHED, ACCT, ACCTS) andBool (VALUE =/=Int 0 orBool          Gzerovaluenewaccountgas &lt;&lt; SCHED &gt;&gt;)</dd>
<dt>rule Cnew(SCHED, ACCT, ACCTS, VALUE) =&gt; 0</dt>
<dd>requires notBool #accountNonexistent(SCHED, ACCT, ACCTS) orBool  (VALUE  ==Int 0 andBool notBool Gzerovaluenewaccountgas &lt;&lt; SCHED &gt;&gt;)</dd>
</dl>
<p class="last">syntax Int ::= Cselfdestruct ( Schedule , Int , Map , Int ) [function]</p>
</dd>
<dt>// ———————————————————————-</dt>
<dd><dl class="first last docutils">
<dt>rule Cselfdestruct(SCHED, ACCT, ACCTS, BAL) =&gt; Gselfdestruct &lt; SCHED &gt; +Int Gnewaccount &lt; SCHED &gt;</dt>
<dd>requires (#accountNonexistent(SCHED, ACCT, ACCTS)) andBool (        Gselfdestructnewaccount &lt;&lt; SCHED &gt;&gt;) andBool (BAL =/=Int 0 orBool          Gzerovaluenewaccountgas &lt;&lt; SCHED &gt;&gt;)</dd>
<dt>rule Cselfdestruct(SCHED, ACCT, ACCTS, BAL) =&gt; Gselfdestruct &lt; SCHED &gt;</dt>
<dd>requires (#accountNonexistent(SCHED, ACCT, ACCTS)) andBool (notBool Gselfdestructnewaccount &lt;&lt; SCHED &gt;&gt;  orBool  (BAL  ==Int 0 andBool notBool Gzerovaluenewaccountgas &lt;&lt; SCHED &gt;&gt;))</dd>
<dt>rule Cselfdestruct(SCHED, ACCT, ACCTS, BAL) =&gt; Gselfdestruct &lt; SCHED &gt;</dt>
<dd>requires notBool #accountNonexistent(SCHED, ACCT, ACCTS)</dd>
<dt>syntax Bool ::= #accountNonexistent ( Schedule , Int , Map ) [function]</dt>
<dd><div class="first last line-block">
<div class="line">#accountEmpty ( Int , Map )                  [function]</div>
</div>
</dd>
</dl>
</dd>
<dt>// ———————————————————————–</dt>
<dd><p class="first">rule #accountNonexistent(SCHED, ACCT, ACCTS) =&gt; notBool ACCT in_keys(ACCTS) orBool (#accountEmpty(ACCT, ACCTS) andBool Gemptyisnonexistent &lt;&lt; SCHED &gt;&gt;)
rule #accountEmpty(ACCT, (ACCT <a href="#id571"><span class="problematic" id="id572">|</span></a>-&gt; EMPTY) _) =&gt; EMPTY</p>
<p class="last">syntax Int ::= #allBut64th ( Int ) [function]</p>
</dd>
<dt>// ———————————————</dt>
<dd><p class="first">rule #allBut64th(N) =&gt; N -Int (N /Int 64)</p>
<p class="last">syntax Int ::= G0 ( Schedule , WordStack , Bool ) [function]</p>
</dd>
<dt>// ————————————————————</dt>
<dd><p class="first">rule G0(SCHED, .WordStack, true)  =&gt; Gtxcreate    &lt; SCHED &gt;
rule G0(SCHED, .WordStack, false) =&gt; Gtransaction &lt; SCHED &gt;</p>
<p>rule G0(SCHED, 0 : REST, ISCREATE) =&gt; Gtxdatazero    &lt; SCHED &gt; +Int G0(SCHED, REST, ISCREATE)
rule G0(SCHED, N : REST, ISCREATE) =&gt; Gtxdatanonzero &lt; SCHED &gt; +Int G0(SCHED, REST, ISCREATE) requires N =/=Int 0</p>
<p class="last">syntax Int ::= “G*” “(” Int “,” Int “,” Int “)” [function]</p>
</dd>
<dt>// ———————————————————-</dt>
<dd>rule G*(GAVAIL, GLIMIT, REFUND) =&gt; GAVAIL +Int minInt((GLIMIT -Int GAVAIL)/Int 2, REFUND)</dd>
</dl>
</dd>
</dl>
<p><a href="#id573"><span class="problematic" id="id574">``</span></a><a href="#id575"><span class="problematic" id="id576">`</span></a></p>
</div>
<div class="section" id="fee-schedule-from-c-implementation">
<h2>Fee Schedule from C++ Implementation<a class="headerlink" href="#fee-schedule-from-c-implementation" title="Permalink to this headline">¶</a></h2>
<p>The [C++ Implementation of EVM](<a class="reference external" href="https://github.com/ethereum/cpp-ethereum">https://github.com/ethereum/cpp-ethereum</a>) specifies several different “profiles” for how the VM works.
Here we provide each protocol from the C++ implementation, as the yellowpaper does not contain all the different profiles.
Specify which profile by passing in the argument <cite>-cSCHEDULE=&lt;FEE_SCHEDULE&gt;</cite> when calling <cite>krun</cite> (the available <cite>&lt;FEE_SCHEDULE&gt;</cite> are supplied here).</p>
<p>A <cite>ScheduleFlag</cite> is a boolean determined by the fee schedule; applying a <cite>ScheduleFlag</cite> to a <cite>Schedule</cite> yields whether the flag is set or not.</p>
<dl class="docutils">
<dt><a href="#id577"><span class="problematic" id="id578">``</span></a><a href="#id579"><span class="problematic" id="id580">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Bool ::= ScheduleFlag “&lt;&lt;” Schedule “&gt;&gt;” [function]</div></blockquote>
<p>// ———————————————————-</p>
<blockquote>
<div>syntax ScheduleFlag ::= “Gselfdestructnewaccount” | “Gstaticcalldepth” | “Gemptyisnonexistent” | “Gzerovaluenewaccountgas”</div></blockquote>
<p class="last">// ————————————————————————————————————————–</p>
</dd>
</dl>
<p><a href="#id581"><span class="problematic" id="id582">``</span></a><a href="#id583"><span class="problematic" id="id584">`</span></a></p>
<p>A <cite>ScheduleConst</cite> is a constant determined by the fee schedule; applying a <cite>ScheduleConst</cite> to a <cite>Schedule</cite> yields the correct constant for that schedule.</p>
<dl class="docutils">
<dt><a href="#id585"><span class="problematic" id="id586">``</span></a><a href="#id587"><span class="problematic" id="id588">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Int ::= ScheduleConst “&lt;” Schedule “&gt;” [function]</div></blockquote>
<p>// ——————————————————–</p>
<blockquote>
<div><dl class="docutils">
<dt>syntax ScheduleConst ::= “Gzero”        | “Gbase”        | “Gverylow”      | “Glow”           | “Gmid”         | “Ghigh”</dt>
<dd><div class="first last line-block">
<div class="line">“Gextcodesize” | “Gextcodecopy” | “Gbalance”      | “Gsload”         | “Gjumpdest”    | “Gsstoreset”</div>
<div class="line">“Gsstorereset” | “Rsstoreclear” | “Rselfdestruct” | “Gselfdestruct”  | “Gcreate”      | “Gcodedeposit”</div>
<div class="line">“Gcall”        | “Gcallvalue”   | “Gcallstipend”  | “Gnewaccount”    | “Gexp”         | “Gexpbyte”</div>
<div class="line">“Gmemory”      | “Gtxcreate”    | “Gtxdatazero”   | “Gtxdatanonzero” | “Gtransaction” | “Glog”          | “Glogdata”</div>
<div class="line">“Glogtopic”    | “Gsha3”        | “Gsha3word”     | “Gcopy”          | “Gblockhash”   | “Gquadcoeff”    | “maxCodeSize”</div>
</div>
</dd>
</dl>
</div></blockquote>
<p class="last">// ————————————————————————————————————————————————</p>
</dd>
</dl>
<p><a href="#id589"><span class="problematic" id="id590">``</span></a><a href="#id591"><span class="problematic" id="id592">`</span></a></p>
<p>### Defualt Schedule</p>
<dl class="docutils">
<dt><a href="#id593"><span class="problematic" id="id594">``</span></a><a href="#id595"><span class="problematic" id="id596">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Schedule ::= “DEFAULT”</div></blockquote>
<dl class="last docutils">
<dt>// —————————–</dt>
<dd><p class="first">rule Gzero    &lt; DEFAULT &gt; =&gt; 0
rule Gbase    &lt; DEFAULT &gt; =&gt; 2
rule Gverylow &lt; DEFAULT &gt; =&gt; 3
rule Glow     &lt; DEFAULT &gt; =&gt; 5
rule Gmid     &lt; DEFAULT &gt; =&gt; 8
rule Ghigh    &lt; DEFAULT &gt; =&gt; 10</p>
<p>rule Gexp      &lt; DEFAULT &gt; =&gt; 10
rule Gexpbyte  &lt; DEFAULT &gt; =&gt; 10
rule Gsha3     &lt; DEFAULT &gt; =&gt; 30
rule Gsha3word &lt; DEFAULT &gt; =&gt; 6</p>
<p>rule Gsload       &lt; DEFAULT &gt; =&gt; 50
rule Gsstoreset   &lt; DEFAULT &gt; =&gt; 20000
rule Gsstorereset &lt; DEFAULT &gt; =&gt; 5000
rule Rsstoreclear &lt; DEFAULT &gt; =&gt; 15000</p>
<p>rule Glog      &lt; DEFAULT &gt; =&gt; 375
rule Glogdata  &lt; DEFAULT &gt; =&gt; 8
rule Glogtopic &lt; DEFAULT &gt; =&gt; 375</p>
<p>rule Gcall        &lt; DEFAULT &gt; =&gt; 40
rule Gcallstipend &lt; DEFAULT &gt; =&gt; 2300
rule Gcallvalue   &lt; DEFAULT &gt; =&gt; 9000
rule Gnewaccount  &lt; DEFAULT &gt; =&gt; 25000</p>
<p>rule Gcreate       &lt; DEFAULT &gt; =&gt; 32000
rule Gcodedeposit  &lt; DEFAULT &gt; =&gt; 200
rule Gselfdestruct &lt; DEFAULT &gt; =&gt; 0
rule Rselfdestruct &lt; DEFAULT &gt; =&gt; 24000</p>
<p>rule Gmemory    &lt; DEFAULT &gt; =&gt; 3
rule Gquadcoeff &lt; DEFAULT &gt; =&gt; 512
rule Gcopy      &lt; DEFAULT &gt; =&gt; 3</p>
<p>rule Gtransaction   &lt; DEFAULT &gt; =&gt; 21000
rule Gtxcreate      &lt; DEFAULT &gt; =&gt; 53000
rule Gtxdatazero    &lt; DEFAULT &gt; =&gt; 4
rule Gtxdatanonzero &lt; DEFAULT &gt; =&gt; 68</p>
<p>rule Gjumpdest    &lt; DEFAULT &gt; =&gt; 1
rule Gbalance     &lt; DEFAULT &gt; =&gt; 20
rule Gblockhash   &lt; DEFAULT &gt; =&gt; 20
rule Gextcodesize &lt; DEFAULT &gt; =&gt; 20
rule Gextcodecopy &lt; DEFAULT &gt; =&gt; 20</p>
<p>rule maxCodeSize &lt; DEFAULT &gt; =&gt; 2 ^Int 32 -Int 1</p>
<p class="last">rule Gselfdestructnewaccount &lt;&lt; DEFAULT &gt;&gt; =&gt; false
rule Gstaticcalldepth        &lt;&lt; DEFAULT &gt;&gt; =&gt; true
rule Gemptyisnonexistent     &lt;&lt; DEFAULT &gt;&gt; =&gt; false
rule Gzerovaluenewaccountgas &lt;&lt; DEFAULT &gt;&gt; =&gt; true</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id597"><span class="problematic" id="id598">``</span></a><a href="#id599"><span class="problematic" id="id600">`</span></a></p>
<p><a href="#id601"><span class="problematic" id="id602">``</span></a><a href="#id603"><span class="problematic" id="id604">`</span></a>c++
struct EVMSchedule
{</p>
<blockquote>
<div><p>EVMSchedule(): tierStepGas(std::array&lt;unsigned, 8&gt;{{0, 2, 3, 5, 8, 10, 20, 0}}) {}
EVMSchedule(bool _efcd, bool _hdc, unsigned const&amp; _txCreateGas): exceptionalFailedCodeDeposit(_efcd), haveDelegateCall(_hdc), tierStepGas(std::array&lt;unsigned, 8&gt;{{0, 2, 3, 5, 8, 10, 20, 0}}), txCreateGas(_txCreateGas) {}
bool exceptionalFailedCodeDeposit = true;
bool haveDelegateCall = true;
bool eip150Mode = false;
bool eip158Mode = false;
bool haveRevert = false;
bool haveReturnData = false;
bool haveStaticCall = false;
bool haveCreate2 = false;
std::array&lt;unsigned, 8&gt; tierStepGas;</p>
<p>unsigned expGas = 10;
unsigned expByteGas = 10;
unsigned sha3Gas = 30;
unsigned sha3WordGas = 6;</p>
<p>unsigned sloadGas = 50;
unsigned sstoreSetGas = 20000;
unsigned sstoreResetGas = 5000;
unsigned sstoreRefundGas = 15000;</p>
<p>unsigned logGas = 375;
unsigned logDataGas = 8;
unsigned logTopicGas = 375;</p>
<p>unsigned callGas = 40;
unsigned callStipend = 2300;
unsigned callValueTransferGas = 9000;
unsigned callNewAccountGas = 25000;</p>
<p>unsigned createGas = 32000;
unsigned createDataGas = 200;
unsigned suicideGas = 0;
unsigned suicideRefundGas = 24000;</p>
<p>unsigned memoryGas = 3;
unsigned quadCoeffDiv = 512;
unsigned copyGas = 3;</p>
<p>unsigned txGas = 21000;
unsigned txCreateGas = 53000;
unsigned txDataZeroGas = 4;
unsigned txDataNonZeroGas = 68;</p>
<p>unsigned jumpdestGas = 1;
unsigned balanceGas = 20;
unsigned blockhashGas = 20;
unsigned extcodesizeGas = 20;
unsigned extcodecopyGas = 20;</p>
<p>unsigned maxCodeSize = unsigned(-1);</p>
<p>bool staticCallDepthLimit() const { return !eip150Mode; }
bool suicideNewAccountGas() const { return !eip150Mode; }
bool suicideChargesNewAccountGas() const { return eip150Mode; }
bool emptinessIsNonexistence() const { return eip158Mode; }
bool zeroValueTransferChargesNewAccountGas() const { return !eip158Mode; }</p>
</div></blockquote>
<div class="section" id="id605">
<h3>};<a class="headerlink" href="#id605" title="Permalink to this headline">¶</a></h3>
<p>### Frontier Schedule</p>
<dl class="docutils">
<dt><a href="#id606"><span class="problematic" id="id607">``</span></a><a href="#id608"><span class="problematic" id="id609">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Schedule ::= “FRONTIER”</div></blockquote>
<dl class="last docutils">
<dt>// ——————————</dt>
<dd><p class="first">rule Gtxcreate  &lt; FRONTIER &gt; =&gt; 21000
rule SCHEDCONST &lt; FRONTIER &gt; =&gt; SCHEDCONST &lt; DEFAULT &gt; requires SCHEDCONST =/=K Gtxcreate</p>
<p class="last">rule SCHEDFLAG &lt;&lt; FRONTIER &gt;&gt; =&gt; SCHEDFLAG &lt;&lt; DEFAULT &gt;&gt;</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id610"><span class="problematic" id="id611">``</span></a><a href="#id612"><span class="problematic" id="id613">`</span></a></p>
<p><code class="docutils literal"><span class="pre">`c++</span>
<span class="pre">static</span> <span class="pre">const</span> <span class="pre">EVMSchedule</span> <span class="pre">FrontierSchedule</span> <span class="pre">=</span> <span class="pre">EVMSchedule(false,</span> <span class="pre">false,</span> <span class="pre">21000);</span>
<span class="pre">`</span></code></p>
<p>### Homestead Schedule</p>
<dl class="docutils">
<dt><a href="#id614"><span class="problematic" id="id615">``</span></a><a href="#id616"><span class="problematic" id="id617">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Schedule ::= “HOMESTEAD”</div></blockquote>
<dl class="last docutils">
<dt>// ——————————-</dt>
<dd><p class="first">rule SCHEDCONST &lt; HOMESTEAD &gt; =&gt; SCHEDCONST &lt; DEFAULT &gt;</p>
<p class="last">rule SCHEDFLAG &lt;&lt; HOMESTEAD &gt;&gt; =&gt; SCHEDFLAG &lt;&lt; DEFAULT &gt;&gt;</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id618"><span class="problematic" id="id619">``</span></a><a href="#id620"><span class="problematic" id="id621">`</span></a></p>
<p><code class="docutils literal"><span class="pre">`c++</span>
<span class="pre">static</span> <span class="pre">const</span> <span class="pre">EVMSchedule</span> <span class="pre">HomesteadSchedule</span> <span class="pre">=</span> <span class="pre">EVMSchedule(true,</span> <span class="pre">true,</span> <span class="pre">53000);</span>
<span class="pre">`</span></code></p>
<p>### EIP150 Schedule</p>
<dl class="docutils">
<dt><a href="#id622"><span class="problematic" id="id623">``</span></a><a href="#id624"><span class="problematic" id="id625">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Schedule ::= “EIP150”</div></blockquote>
<dl class="last docutils">
<dt>// —————————-</dt>
<dd><p class="first">rule Gbalance      &lt; EIP150 &gt; =&gt; 400
rule Gsload        &lt; EIP150 &gt; =&gt; 200
rule Gcall         &lt; EIP150 &gt; =&gt; 700
rule Gselfdestruct &lt; EIP150 &gt; =&gt; 5000
rule Gextcodesize  &lt; EIP150 &gt; =&gt; 700
rule Gextcodecopy  &lt; EIP150 &gt; =&gt; 700</p>
<dl class="docutils">
<dt>rule SCHEDCONST    &lt; EIP150 &gt; =&gt; SCHEDCONST &lt; HOMESTEAD &gt;</dt>
<dd><dl class="first last docutils">
<dt>requires notBool      ( SCHEDCONST ==K Gbalance      orBool SCHEDCONST ==K Gsload       orBool SCHEDCONST ==K Gcall</dt>
<dd><dl class="first last docutils">
<dt>orBool SCHEDCONST ==K Gselfdestruct orBool SCHEDCONST ==K Gextcodesize orBool SCHEDCONST ==K Gextcodecopy</dt>
<dd>)</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p>rule Gselfdestructnewaccount &lt;&lt; EIP150 &gt;&gt; =&gt; true
rule Gstaticcalldepth        &lt;&lt; EIP150 &gt;&gt; =&gt; false
rule SCHEDCONST              &lt;&lt; EIP150 &gt;&gt; =&gt; SCHEDCONST &lt;&lt; HOMESTEAD &gt;&gt;</p>
<blockquote class="last">
<div>requires notBool      ( SCHEDCONST ==K Gselfdestructnewaccount orBool SCHEDCONST ==K Gstaticcalldepth )</div></blockquote>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id626"><span class="problematic" id="id627">``</span></a><a href="#id628"><span class="problematic" id="id629">`</span></a></p>
<p><a href="#id630"><span class="problematic" id="id631">``</span></a><a href="#id632"><span class="problematic" id="id633">`</span></a>c++
static const EVMSchedule EIP150Schedule = []
{</p>
<blockquote>
<div>EVMSchedule schedule = HomesteadSchedule;
schedule.eip150Mode = true;
schedule.extcodesizeGas = 700;
schedule.extcodecopyGas = 700;
schedule.balanceGas = 400;
schedule.sloadGas = 200;
schedule.callGas = 700;
schedule.suicideGas = 5000;
return schedule;</div></blockquote>
<p>}();
<a href="#id634"><span class="problematic" id="id635">``</span></a><a href="#id636"><span class="problematic" id="id637">`</span></a></p>
<p>### EIP158 Schedule</p>
<dl class="docutils">
<dt><a href="#id638"><span class="problematic" id="id639">``</span></a><a href="#id640"><span class="problematic" id="id641">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Schedule ::= “EIP158”</div></blockquote>
<dl class="last docutils">
<dt>// —————————-</dt>
<dd><p class="first">rule Gexpbyte    &lt; EIP158 &gt; =&gt; 50
rule maxCodeSize &lt; EIP158 &gt; =&gt; 24576</p>
<p>rule SCHEDCONST  &lt; EIP158 &gt; =&gt; SCHEDCONST &lt; EIP150 &gt; requires SCHEDCONST =/=K Gexpbyte andBool SCHEDCONST =/=K maxCodeSize</p>
<p>rule Gemptyisnonexistent     &lt;&lt; EIP158 &gt;&gt; =&gt; true
rule Gzerovaluenewaccountgas &lt;&lt; EIP158 &gt;&gt; =&gt; false
rule SCHEDCONST              &lt;&lt; EIP158 &gt;&gt; =&gt; SCHEDCONST &lt;&lt; EIP150 &gt;&gt;</p>
<blockquote class="last">
<div>requires notBool      ( SCHEDCONST ==K Gemptyisnonexistent orBool SCHEDCONST ==K Gzerovaluenewaccountgas )</div></blockquote>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id642"><span class="problematic" id="id643">``</span></a><a href="#id644"><span class="problematic" id="id645">`</span></a></p>
<p><a href="#id646"><span class="problematic" id="id647">``</span></a><a href="#id648"><span class="problematic" id="id649">`</span></a>c++
static const EVMSchedule EIP158Schedule = []
{</p>
<blockquote>
<div>EVMSchedule schedule = EIP150Schedule;
schedule.expByteGas = 50;
schedule.eip158Mode = true;
schedule.maxCodeSize = 0x6000;
return schedule;</div></blockquote>
<p>}();
<a href="#id650"><span class="problematic" id="id651">``</span></a><a href="#id652"><span class="problematic" id="id653">`</span></a></p>
<p>### Byzantium Schedule</p>
<dl class="docutils">
<dt><a href="#id654"><span class="problematic" id="id655">``</span></a><a href="#id656"><span class="problematic" id="id657">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Schedule ::= “BYZANTIUM”</div></blockquote>
<dl class="last docutils">
<dt>// ——————————-</dt>
<dd><p class="first">rule SCHEDCONST &lt; BYZANTIUM &gt; =&gt; SCHEDCONST &lt; EIP158 &gt;</p>
<p class="last">rule SCHEDFLAG &lt;&lt; BYZANTIUM &gt;&gt; =&gt; SCHEDFLAG &lt;&lt; EIP158 &gt;&gt;</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id658"><span class="problematic" id="id659">``</span></a><a href="#id660"><span class="problematic" id="id661">`</span></a></p>
<p><a href="#id662"><span class="problematic" id="id663">``</span></a><a href="#id664"><span class="problematic" id="id665">`</span></a>c++
static const EVMSchedule ByzantiumSchedule = []
{</p>
<blockquote>
<div>EVMSchedule schedule = EIP158Schedule;
schedule.haveRevert = true;
schedule.haveReturnData = true;
schedule.haveStaticCall = true;
schedule.blockRewardOverwrite = {3 * ether};
return schedule;</div></blockquote>
<p>}();
<a href="#id666"><span class="problematic" id="id667">``</span></a><a href="#id668"><span class="problematic" id="id669">`</span></a></p>
<p>### Constantinople Schedule</p>
<dl class="docutils">
<dt><a href="#id670"><span class="problematic" id="id671">``</span></a><a href="#id672"><span class="problematic" id="id673">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div>syntax Schedule ::= “CONSTANTINOPLE”</div></blockquote>
<dl class="last docutils">
<dt>// ————————————</dt>
<dd><p class="first">rule Gblockhash &lt; CONSTANTINOPLE &gt; =&gt; 800
rule SCHEDCONST &lt; CONSTANTINOPLE &gt; =&gt; SCHEDCONST &lt; BYZANTIUM &gt;</p>
<blockquote>
<div>requires SCHEDCONST =/=K Gblockhash</div></blockquote>
<p class="last">rule SCHEDFLAG &lt;&lt; CONSTANTINOPLE &gt;&gt; =&gt; SCHEDFLAG &lt;&lt; BYZANTIUM &gt;&gt;</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id674"><span class="problematic" id="id675">``</span></a><a href="#id676"><span class="problematic" id="id677">`</span></a></p>
<p><a href="#id678"><span class="problematic" id="id679">``</span></a><a href="#id680"><span class="problematic" id="id681">`</span></a>c++
static const EVMSchedule ConstantinopleSchedule = []
{</p>
<blockquote>
<div>EVMSchedule schedule = ByzantiumSchedule;
schedule.blockhashGas = 800;
schedule.haveCreate2 = true;
return schedule;</div></blockquote>
<p>}();
<a href="#id682"><span class="problematic" id="id683">``</span></a><a href="#id684"><span class="problematic" id="id685">`</span></a></p>
</div>
</div>
</div>
<div class="section" id="evm-program-representations">
<h1>EVM Program Representations<a class="headerlink" href="#evm-program-representations" title="Permalink to this headline">¶</a></h1>
<p>EVM programs are represented algebraically in K, but programs can load and manipulate program data directly.
The opcodes <cite>CODECOPY</cite> and <cite>EXTCODECOPY</cite> rely on the assembled form of the programs being present.
The opcode <cite>CREATE</cite> relies on being able to interperet EVM data as a program.</p>
<p>This is a program representation dependence, which we might want to avoid.
Perhaps the only program representation dependence we should have is the hash of the program; doing so achieves:</p>
<ul class="simple">
<li>Program representation independence (different analysis tools on the language don’t have to ensure they have a common representation of programs, just a common interperetation of the data-files holding programs).</li>
<li>Programming language independence (we wouldn’t even have to commit to a particular language or interperetation of the data-file).</li>
<li>Only depending on the hash allows us to know that we have <em>exactly</em> the correct data-file (program), and nothing more.</li>
</ul>
<div class="section" id="disassembler">
<h2>Disassembler<a class="headerlink" href="#disassembler" title="Permalink to this headline">¶</a></h2>
<p>After interpreting the strings representing programs as a <cite>WordStack</cite>, it should be changed into an <cite>OpCodes</cite> for use by the EVM semantics.</p>
<ul class="simple">
<li><cite>#dasmOpCodes</cite> interperets <cite>WordStack</cite> as an <cite>OpCodes</cite>.</li>
<li><cite>#dasmPUSH</cite> handles the case of a <cite>PushOp</cite>.</li>
<li><cite>#dasmOpCode</cite> interperets a <cite>Int</cite> as an <cite>OpCode</cite>.</li>
</ul>
<dl class="docutils">
<dt><a href="#id686"><span class="problematic" id="id687">``</span></a><a href="#id688"><span class="problematic" id="id689">`</span></a>{.k .uiuck .rvk}</dt>
<dd><blockquote class="first">
<div><dl class="docutils">
<dt>syntax OpCodes ::= #dasmOpCodes ( WordStack , Schedule )           [function]</dt>
<dd><div class="first last line-block">
<div class="line">#dasmOpCodes ( OpCodes , WordStack , Schedule ) [function, klabel(#dasmOpCodesAux)]</div>
<div class="line">#revOpCodes  ( OpCodes , OpCodes )              [function]</div>
</div>
</dd>
</dl>
</div></blockquote>
<dl class="last docutils">
<dt>// —————————————————————————–</dt>
<dd><p class="first">rule #dasmOpCodes( WS, SCHED ) =&gt; #revOpCodes(#dasmOpCodes(.OpCodes, WS, SCHED), .OpCodes)</p>
<p>rule #dasmOpCodes( OPS, .WordStack, _ ) =&gt; OPS
rule #dasmOpCodes( OPS, W : WS, SCHED ) =&gt; #dasmOpCodes(#dasmOpCode(W, SCHED) ; OPS, WS, SCHED) requires W &gt;=Int 0   andBool W &lt;=Int 95
rule #dasmOpCodes( OPS, W : WS, SCHED ) =&gt; #dasmOpCodes(#dasmOpCode(W, SCHED) ; OPS, WS, SCHED) requires W &gt;=Int 165 andBool W &lt;=Int 255
rule #dasmOpCodes( OPS, W : WS, SCHED ) =&gt; #dasmOpCodes(DUP(W -Int 127)       ; OPS, WS, SCHED) requires W &gt;=Int 128 andBool W &lt;=Int 143
rule #dasmOpCodes( OPS, W : WS, SCHED ) =&gt; #dasmOpCodes(SWAP(W -Int 143)      ; OPS, WS, SCHED) requires W &gt;=Int 144 andBool W &lt;=Int 159
rule #dasmOpCodes( OPS, W : WS, SCHED ) =&gt; #dasmOpCodes(LOG(W -Int 160)       ; OPS, WS, SCHED) requires W &gt;=Int 160 andBool W &lt;=Int 164</p>
<p>rule #dasmOpCodes( OPS, W : WS, SCHED ) =&gt; #dasmOpCodes(PUSH(W -Int 95, #asWord(#take(W -Int 95, WS))) ; OPS, #drop(W -Int 95, WS), SCHED) requires W &gt;=Int 96  andBool W &lt;=Int 127</p>
<p>rule #revOpCodes ( OP ; OPS , OPS’ ) =&gt; #revOpCodes(OPS, OP ; OPS’)
rule #revOpCodes ( .OpCodes , OPS  ) =&gt; OPS</p>
<p class="last">syntax OpCode ::= #dasmOpCode ( Int , Schedule ) [function]</p>
</dd>
<dt>// ———————————————————–</dt>
<dd>rule #dasmOpCode(   0,     _ ) =&gt; STOP
rule #dasmOpCode(   1,     _ ) =&gt; ADD
rule #dasmOpCode(   2,     _ ) =&gt; MUL
rule #dasmOpCode(   3,     _ ) =&gt; SUB
rule #dasmOpCode(   4,     _ ) =&gt; DIV
rule #dasmOpCode(   5,     _ ) =&gt; SDIV
rule #dasmOpCode(   6,     _ ) =&gt; MOD
rule #dasmOpCode(   7,     _ ) =&gt; SMOD
rule #dasmOpCode(   8,     _ ) =&gt; ADDMOD
rule #dasmOpCode(   9,     _ ) =&gt; MULMOD
rule #dasmOpCode(  10,     _ ) =&gt; EXP
rule #dasmOpCode(  11,     _ ) =&gt; SIGNEXTEND
rule #dasmOpCode(  16,     _ ) =&gt; LT
rule #dasmOpCode(  17,     _ ) =&gt; GT
rule #dasmOpCode(  18,     _ ) =&gt; SLT
rule #dasmOpCode(  19,     _ ) =&gt; SGT
rule #dasmOpCode(  20,     _ ) =&gt; EQ
rule #dasmOpCode(  21,     _ ) =&gt; ISZERO
rule #dasmOpCode(  22,     _ ) =&gt; AND
rule #dasmOpCode(  23,     _ ) =&gt; EVMOR
rule #dasmOpCode(  24,     _ ) =&gt; XOR
rule #dasmOpCode(  25,     _ ) =&gt; NOT
rule #dasmOpCode(  26,     _ ) =&gt; BYTE
rule #dasmOpCode(  32,     _ ) =&gt; SHA3
rule #dasmOpCode(  48,     _ ) =&gt; ADDRESS
rule #dasmOpCode(  49,     _ ) =&gt; BALANCE
rule #dasmOpCode(  50,     _ ) =&gt; ORIGIN
rule #dasmOpCode(  51,     _ ) =&gt; CALLER
rule #dasmOpCode(  52,     _ ) =&gt; CALLVALUE
rule #dasmOpCode(  53,     _ ) =&gt; CALLDATALOAD
rule #dasmOpCode(  54,     _ ) =&gt; CALLDATASIZE
rule #dasmOpCode(  55,     _ ) =&gt; CALLDATACOPY
rule #dasmOpCode(  56,     _ ) =&gt; CODESIZE
rule #dasmOpCode(  57,     _ ) =&gt; CODECOPY
rule #dasmOpCode(  58,     _ ) =&gt; GASPRICE
rule #dasmOpCode(  59,     _ ) =&gt; EXTCODESIZE
rule #dasmOpCode(  60,     _ ) =&gt; EXTCODECOPY
rule #dasmOpCode(  64,     _ ) =&gt; BLOCKHASH
rule #dasmOpCode(  65,     _ ) =&gt; COINBASE
rule #dasmOpCode(  66,     _ ) =&gt; TIMESTAMP
rule #dasmOpCode(  67,     _ ) =&gt; NUMBER
rule #dasmOpCode(  68,     _ ) =&gt; DIFFICULTY
rule #dasmOpCode(  69,     _ ) =&gt; GASLIMIT
rule #dasmOpCode(  80,     _ ) =&gt; POP
rule #dasmOpCode(  81,     _ ) =&gt; MLOAD
rule #dasmOpCode(  82,     _ ) =&gt; MSTORE
rule #dasmOpCode(  83,     _ ) =&gt; MSTORE8
rule #dasmOpCode(  84,     _ ) =&gt; SLOAD
rule #dasmOpCode(  85,     _ ) =&gt; SSTORE
rule #dasmOpCode(  86,     _ ) =&gt; JUMP
rule #dasmOpCode(  87,     _ ) =&gt; JUMPI
rule #dasmOpCode(  88,     _ ) =&gt; PC
rule #dasmOpCode(  89,     _ ) =&gt; MSIZE
rule #dasmOpCode(  90,     _ ) =&gt; GAS
rule #dasmOpCode(  91,     _ ) =&gt; JUMPDEST
rule #dasmOpCode( 240,     _ ) =&gt; CREATE
rule #dasmOpCode( 241,     _ ) =&gt; CALL
rule #dasmOpCode( 242,     _ ) =&gt; CALLCODE
rule #dasmOpCode( 243,     _ ) =&gt; RETURN
rule #dasmOpCode( 244, SCHED ) =&gt; DELEGATECALL requires SCHED =/=K FRONTIER
rule #dasmOpCode( 255,     _ ) =&gt; SELFDESTRUCT
rule #dasmOpCode(   W,     _ ) =&gt; INVALID [owise]</dd>
</dl>
</dd>
</dl>
<p>endmodule
<a href="#id690"><span class="problematic" id="id691">``</span></a><a href="#id692"><span class="problematic" id="id693">`</span></a></p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../ethereum/" class="btn btn-neutral float-right" title="Ethereum Simulations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../" class="btn btn-neutral" title="The EVM Jello Paper" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, The KEVM Team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>